<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTI-CMM Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Load the CMM data from the JSON file before the main script runs
        (async () => {
            try {
                // === CACHE BUSTING MODIFICATION ===
                // Appending the current time as a query string forces the browser
                // to download a fresh copy every time.
                const response = await fetch('cti-cmm-data.json?v=' + new Date().getTime());
                // === END MODIFICATION ===

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Attach CMM_DATA to window so the module can access it
                window.CMM_DATA = await response.json();
                console.log('CMM data loaded from JSON.');
                
                // ==================================
                // === START REFACTOR MODIFICATION ===
                // =Ill call the module's init method instead of a global function
                CTICMMTool.init(); 
                // === END REFACTOR MODIFICATION ===
                // ==================================

            } catch (e) {
                console.error("Failed to load cti-cmm-data.json:", e);
                // Display an error to the user on the page
                document.body.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Fatal Error:</strong>
                    <span class="block sm:inline">Could not load assessment data file (cti-cmm-data.json). Please ensure the file is present and accessible.</span>
                </div>`;
            }
        })();
    </script>
    <style>
        /* [All CSS styles remain unchanged] */
        /* ... */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #64748b; /* slate-500 */
        }
        ::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
        td input, td select, td textarea {
            font-size: 0.875rem; /* text-sm */
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            max-width: 100%;
            box-sizing: border-box;
        }
        .nav-link.active {
            background-color: #334155; /* slate-700 */
            font-weight: 600;
        }
        .cell-sm {
            width: 5rem; /* 80px */
        }
        .cell-md {
            width: 10rem; /* 160px */
        }
        .cell-lg {
            width: 20rem; /* 320px */
        }
        .page {
            display: none;
        }
        .assessment-table th, .assessment-table td {
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            vertical-align: top;
            border-bottom-width: 1px;
            border-color: #e5e7eb; /* slate-200 */
        }
        .assessment-table th {
            background-color: #f8fafc; /* slate-50 */
            text-align: left;
            font-weight: 500; /* medium */
            color: #475569; /* slate-600 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem; /* text-xs */
        }
        .widget-label {
            font-size: 0.65rem; /* 10px */
            font-weight: 500; /* medium */
            color: #475569; /* slate-600 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-bottom: 0.25rem; /* pb-1 */
            padding-left: 0.25rem; /* pl-1 */
        }
        .maturity-widget, .target-widget {
            display: flex;
            align-items: flex-start; /* Aligns dots and lines */
            padding-left: 2px; /* Small offset */
        }
        .maturity-widget {
             padding-top: 4px; /* Align with other inputs */
        }
        .target-widget {
             padding-top: 4px;
        }
        .maturity-line, .target-line {
            width: 40px; /* Fixed width for compactness */
            height: 2px;
            background-color: #cbd5e1; /* slate-300 */
            transition: background-color 0.2s ease;
            margin-top: 8px; /* Aligns line with center of 18px dot */
        }
        .maturity-label {
            font-size: 0.75rem; /* text-xs */
            color: #64748b; /* slate-500 */
            margin-top: 0.25rem; /* mt-1 */
            width: 18px; /* Match the dot width */
            text-align: center; /* Center the number */
        }
        .maturity-dot {
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1; /* slate-300 */
            border-radius: 50%;
            cursor: pointer;
            background-color: #fff;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        .maturity-dot:hover { border-color: #3b82f6; /* blue-500 */ }
        .maturity-dot.active { background-color: #3b82f6; border-color: #3b82f6; }
        .maturity-dot.selected {
            border-color: #1d4ed8; /* blue-700 */
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .maturity-line.active { background-color: #3b82f6; }
        .target-dot {
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1; /* slate-300 */
            border-radius: 50%;
            cursor: pointer;
            background-color: #fff;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        .target-dot:hover { border-color: #22c55e; /* green-500 */ }
        .target-dot.active { background-color: #22c55e; border-color: #22c55e; }
        .target-dot.selected {
            border-color: #15803d; /* green-700 */
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        }
        .target-line.active { background-color: #22c55e; }
        .sortable-header {
            cursor: pointer;
            user-select: none; /* Prevent text selection on click */
            position: relative; /* For icon positioning */
        }
        .sortable-header:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .sortable-header span {
            display: inline-block;
            width: 1em; /* Reserve space */
            text-align: right;
            color: #94a3b8; /* slate-400 */
        }
        .sortable-header.sort-asc span::after {
            content: '▲';
            color: #334155; /* slate-700 */
        }
        .sortable-header.sort-desc span::after {
            content: '▼';
            color: #334155; /* slate-700 */
        }
        .sortable-header:not(.sort-asc):not(.sort-desc) span::after {
            content: '↕'; /* Default icon */
        }
        .content-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        /* === NEW STYLES FOR WIDGET WARNING === */
        .target-widget.widget-warning .target-dot {
            border-color: #f59e0b; /* amber-500 */
        }
        .target-widget.widget-warning .target-dot:hover {
            border-color: #d97706; /* amber-600 */
        }
        .target-widget.widget-warning .target-dot.active {
            background-color: #f59e0b; /* amber-500 */
            border-color: #b45309; /* amber-700 */
        }
        .target-widget.widget-warning .target-line.active {
            background-color: #f59e0b; /* amber-500 */
        }
        /* === END NEW STYLES === */
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900">

    <div class="flex h-screen overflow-hidden">
        <nav class="w-64 bg-slate-800 text-slate-200 flex-shrink-0 overflow-y-auto">
            <div class="p-4">
                <h1 class="text-xl font-bold text-white">CTI-CMM Tool</h1>
                <span class="text-sm text-slate-400">Assessment v1.5</span>
            </div>
            <ul id="main-nav" class="space-y-1 p-2">
                <li><a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700" data-page="home">Home</a></li>
                <li><a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700" data-page="about">About</a></li>
                <li><a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700" data-page="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700" data-page="priorities">Priorities Sheet</a></li>
                
                <li class="pt-4">
                    <h2 class="px-3 text-sm font-semibold text-slate-400 uppercase tracking-wider">Domain completion %</h2>
                    <ul id="domain-nav" class="mt-1 space-y-1">
                        </ul>
                </li>

                <li class="pt-8">
                    <h2 class="px-3 text-sm font-semibold text-slate-400 uppercase tracking-wider">Settings</h2>
                    <div class="p-3 text-sm">
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-slate-200">Planning Mode</span>
                            <div class="relative">
                                <input type="checkbox" id="mode-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-600 rounded-full peer-checked:bg-blue-600"></div>
                                <div class="absolute top-0.5 left-[2px] bg-white w-5 h-5 rounded-full transition-all peer-checked:translate-x-full"></div>
                            </div>
                        </label>
                        <p class="mt-2 text-xs text-slate-500">
                            Enable to show Target, Priority, and planning fields.
                        </p>
                    </div>
                </li>
                <li class="pt-8">
                    <h2 class="px-3 text-sm font-semibold text-slate-400 uppercase tracking-wider">Data</h2>
                    <div class="p-2 space-y-3">
                        <div>
                            <label for="assessment-name" class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Assessment Name</label>
                            <input type="text" id="assessment-name" class="mt-1 w-full bg-slate-700 text-white text-sm p-2 rounded-md border border-slate-600 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Q3 2025 Assessment">
                        </div>

                        <button id="export-json" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded-md">
                            Export Results (.json)
                        </button>

                        <div>
                            <label for="import-json" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded-md cursor-pointer block text-center">
                                Import Results (.json)
                            </label>
                            <input type="file" id="import-json" class="hidden" accept=".json,application/json">
                        </div>

                        <button id="reset-data" class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded-md">
                            Reset All Data
                        </button>
                        <p class="mt-2 text-xs text-slate-500">
                            Scores are locally saved in your browser. This button clears all your saved scores. This cannot be undone.
                        </p>
                    </div>
                </li>
            </ul>
        </nav>

        <main id="main-content" class="flex-1 overflow-y-auto p-6 md:p-8">
            
            <div id="page-home" class="page max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-slate-800 mb-4">Welcome to the CTI-CMM Assessment Tool (BETA Version 1.5)</h2>
                    <p class="text-lg text-slate-600 mb-6">The Cyber Threat Intelligence Capability Maturity Model (CTI-CMM) is designed to help improve cyber threat intelligence teams support to cybersecurity and risk management functions, leading to improved security outcomes. Its goal is to provide a roadmap on how intelligence programs can mature existing support and process constructs to ultimately strengthen the organization's operational resilience. The CTI-CMM is industry sector, organization type, and size agnostic and was inspired by the U.S. Department of Energy's C2M2 cybersecurity framework. </p>

                    <p class="text-lg text-slate-600 mb-6">The CTI-CMM offers a stakeholder-first approach to CTI maturity. The CTI-CMM focuses on the implementation and management of CTI best practices associated with information technology (IT), operational technology (OT), and information assets and the environments in which they operate. The model can be used to:</p>
        
        <div class="text-lg text-slate-600 mb-6">
            <ul class="list-disc pl-5 space-y-1">
                <li>Enable organizations to effectively and consistently evaluate and benchmark cyber threat intelligence capabilities</li>
                <li>Improve organizational reach and support to cybersecurity and risk management stakeholders</li>
                <li>Establish a roadmap to grow CTI program capabilities and improve existing maturity</li>
                <li>Prioritize investment and actions to improve cyber threat intelligence capabilities</li>
                <li>Share knowledge and best practices on CTI program operations</li>
            </ul>
        </div>
                    <p class="text-lg text-slate-600 mb-6"></p>

                    <div class="prose max-w-none prose-slate">
                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">How to Use This Tool</h3>
                        <p class="text-lg text-slate-600 mb-6">This tool is a stand-alone web application to help you self-evaluate your current maturity posture across each of the CTI-CMM domains.</p>
                        <ol class="list-decimal list-inside space-y-2">
                            <li  class="text-lg text-slate-600 mb-6"><strong>Navigate Domains:</strong> Use the sidebar to select one of the 11 CTI-CMM domains.</li>
                            <li  class="text-lg text-slate-600 mb-6"><strong>Choose Your Mode:</strong> Use the "Planning Mode" toggle in the sidebar.
                                <ul class="list-disc list-inside">
                                    <li><strong>Benchmark Mode (Off):</strong> Assess your `Current` maturity and add `Evidence`, `Point of Contact`, and `Notes`.</li>
                                    <li><strong>Planning Mode (On):</strong> Adds fields for `Target` maturity, `Target Date`, `Impact`, `Effort`, and `Priority`.</li>
                                </ul>
                            </li>
                            <li class="text-lg text-slate-600 mb-6"><strong>Self-Assess:</strong> For each practice, select your <strong>Current</strong> and <strong>Target</strong> Maturity (0-3) using the clickable dot widgets. Your progress is tracked by the progress bars in the sidebar.</li>
                            <li class="text-lg text-slate-600 mb-6"><strong>Mark Practices Relevant:</strong> Use the "Relevant" toggle on the top right of each practice to include or exclude it from scoring.</li>
                            <li class="text-lg text-slate-600 mb-6"><strong>Auto-Save:</strong> All your entries are saved to your browser's local storage automatically. You can leave and come back at any time.</li>
                            <li class="text-lg text-slate-600 mb-6"><strong>View Results:</strong>
                                <ul class="list-disc list-inside">
                                    <li>The <strong>Dashboard</strong> shows your overall maturity and completion percentage for each domain.</li>
                                    <li>The <strong>Priorities Sheet</strong> (available in Planning Mode) aggregates all your assessment items and helps you plan your improvement journey.</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">The 11 CTI-CMM Domains</h3>
                        <p class="text-lg text-slate-600 mb-6">The CTI-CMM v1.2 is organized into 11 domains, comprised of two or more objectives:</p>
                        <ul class="list-decimal list-inside text-lg text-slate-600 mb-6">
                            <li>Asset, Change, and Configuration Management (ASSET)</li>
                            <li>Threat and Vulnerability Management (THREAT)</li>
                            <li>Risk Management (RISK)</li>
                            <li>Identity and Access Management (ACCESS)</li>
                            <li>Situational Awareness (SITUATION)</li>
                            <li>Event and Incident Response, Continuity of Operations (RESPONSE)</li>
                            <li>Third-Party Risk Management (THIRD-PARTIES)</li>
                            <li>Fraud and Abuse Management (FRAUD)</li>
                            <li>Workforce Management (WORKFORCE)</li>
                            <li>Cybersecurity Architecture (ARCHITECTURE)</li>
                            <li>Cybersecurity Program Management (PROGRAM)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="page-dashboard" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Assessment Dashboard</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Domain Maturity Overview</h3>
                        <div class="relative h-96 w-full">
                            <canvas id="maturityRadarChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Overall Progress</h3>
                        <div class="relative h-96 w-full flex items-center justify-center">
                            <canvas id="overallProgressDoughnut"></canvas>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-white rounded-lg shadow-md overflow-hidden">
                    <h3 class="text-xl font-semibold p-6">Domain Subtotals</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Domain</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Score</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Max Score</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Maturity %</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target %</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-slate-200">
                                </tbody>
                            <tfoot class="bg-slate-50">
                                <tr id="dashboard-table-footer" class="font-bold">
                                    </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-assessment" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="assessment-title" class="text-3xl font-bold text-slate-800"></h2>
                    <div class="flex space-x-2">
                        <button id="expand-all" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md text-sm font-medium">Expand All</button>
                        <button id="collapse-all" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md text-sm font-medium">Collapse All</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
                    <div>
                        <span class="font-bold">Date Last Assessed:</span>
                        <input type="date" id="assessment-date" class="ml-2 p-1 border rounded-md">
                    </div>
                    <div>
                        <label for="assessment-relevant" class="font-bold">Domain is Relevant?</label>
                        <input type="checkbox" id="assessment-relevant" class="ml-2 h-5 w-5 text-blue-600 rounded">
                    </div>
                    <div id="assessment-summary" class="text-right">
                        </div>
                </div>
                
                <div id="assessment-disabled-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                    <p class="font-bold">This domain is marked as 'Not Relevant'</p>
                    <p>It will be excluded from all scoring, totals, and planning. To re-enable, check the "Domain is Relevant?" box above.</p>
                </div>
                <div id="assessment-objectives-container" class="space-y-6">
                    </div>
            </div>

            <div id="page-priorities" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Priorities Planning Sheet</h2>

                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">What is this?</h3>
                    <p class="text-slate-600">This planning sheet aggregates all practices where your <strong>Target Score</strong> is greater than your current <strong>Score</strong> (or where your Current Score is not yet set). Click any column header to sort the list and help you plan your improvement journey.</p>
                    <p class="text-slate-600 mt-2">Only practices from 'Relevant' domains that are individually marked 'Relevant' are shown here.</p>
                    <div class="mt-4">
                        <button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                            Export to CSV
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="domain">Domain <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="practice">Practice <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="score">Score <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="target">Target <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="impact">Impact <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="loe">Effort <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="priority">Priority <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="date">Target Date <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="notes">Notes <span></span></th>
                                </tr>
                            </thead>
                            <tbody id="priorities-table-body" class="bg-white divide-y divide-slate-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-about" class="page max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-slate-800 mb-6">About the CTI-CMM Tool</h2>
            
                    <div class="prose max-w-none prose-slate">
                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">About</h3>
                        <p class="text-lg text-slate-600 mb-6">
                             This web assessment tool is an alternative to the <a href="https://cti-cmm.org/beta-assessment-tool" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-semibold underline decoration-2 decoration-blue-200 hover:text-blue-800 hover:decoration-blue-400 px-1 rounded-sm focus:outline-none focus:ring-2 focus:ring-blue-200 transition">spreadsheet version</a> of the CTI-CMM. 
                             It provides an interactive interface, auto-saving capabilities, import / export of results and a dashboard to visualize your maturity posture.
                        </p>
            
                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">Version History</h3>
                        <div class="text-lg text-slate-600 mb-6">
                            <ul class="space-y-3">
                                <li>
                                    <strong>v3 (2025-11-14):</strong>
                                    <ul class="list-disc pl-6 mt-2 space-y-1">
                                        <li>Import / export assessment data</li>
                                        <li>Disable individual Practices</li>
                                        <li>Use JS objects in codebase</li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>v2 (2025-11-08):</strong>
                                    <ul class="list-disc pl-6 mt-2 space-y-1">
                                        <li>Added Planning Mode</li>
                                        <li>Added short Practice names</li>
                                        <li>Improved score / target widgets</li>
                                        <li>Calculate Practice priorities</li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>v1 (2025-11-04):</strong>
                                    <ul class="list-disc pl-6 mt-2 space-y-1">
                                        <li>Basic conversion of XLS assessment tool</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
            
                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">Repo</h3>
                        <p class="text-lg text-slate-600 mb-6">
                            The source code for this tool is available on <a href="https://github.com/chorsley/cti-cmm-assessment-tool" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-semibold underline decoration-2 decoration-blue-200 hover:text-blue-800 hover:decoration-blue-400 px-1 rounded-sm focus:outline-none focus:ring-2 focus:ring-blue-200 transition">GitHub</a> under the MIT License.
                        </p>

                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">Contact</h3>
                        <p class="text-lg text-slate-600 mb-6">
                            Maintained by Chris Horsley at <a href="https://cosive.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-semibold underline decoration-2 decoration-blue-200 hover:text-blue-800 hover:decoration-blue-400 px-1 rounded-sm focus:outline-none focus:ring-2 focus:ring-blue-200 transition">Cosive</a> in Melbourne, Australia. For questions or feedback, please reach out via <a href="mailto:hello@cosive.com" class="text-blue-600 font-semibold underline decoration-2 decoration-blue-200 hover:text-blue-800 hover:decoration-blue-400 px-1 rounded-sm focus:outline-none focus:ring-2 focus:ring-blue-200 transition">hello@cosive.com</a>.
                        </p>
                    </div>
                </div>
            </div>
            </main>
    </div>

    <script>
    
// ========================================================================
// === CTI-CMM DATA MODEL CLASSES =========================================
// ========================================================================

/**
 * Represents a single assessment practice.
 * It holds both the static data (from cti-cmm-data.json)
 * and the user-editable data (from localStorage).
 */
class Practice {
    // --- Static Data (from JSON) ---
    id;
    maturity;
    text;
    slug;
    max;

    // --- User Data (with defaults) ---
    score = null;
    targetScore = null;
    impact = 1;
    loe = 1;
    evidence = '';
    poc = '';
    targetDate = '';
    notes = '';
    relevant = true; // === NEW v1.6 ===

    /**
     * Creates a Practice instance from the static cti-cmm-data.json data.
     * --- FIX v1.5 ---
     * This constructor now *only* copies static properties, preserving the
     * class defaults (like `score = null`) for user-editable fields.
     * This prevents the `score: 0` from the JSON file from being used.
     */
    constructor(staticData) {
        // Manually assign only the *static* properties
        this.id = staticData.id;
        this.maturity = staticData.maturity;
        this.text = staticData.text;
        this.slug = staticData.slug;
        this.max = staticData.max;
        
        // This ensures that the class property defaults for user data
        // (like `score = null`) are preserved, and the `score: 0`
        // from the JSON file is ignored.
    }

    /**
     * Applies saved user data (from import/localStorage) to this instance.
     * This is the "deserialization" step.
     */
    loadUserData(savedData) {
        // Define which keys are user-editable
        const userKeys = [
            'score', 'targetScore', 'impact', 'loe', 
            'evidence', 'poc', 'targetDate', 'notes',
            'relevant' // === NEW v1.6 ===
        ];
        
        for (const key of userKeys) {
            // Check if the key exists in the saved data to avoid
            // overwriting defaults with 'undefined'
            if (savedData[key] !== undefined) {
                this[key] = savedData[key];
            }
        }
    }

    /**
     * Returns a clean POJO (Plain Old JavaScript Object)
     * of *only* the user-editable data for saving.
     * This is the "serialization" step.
     */
    serialize() {
        return {
            id: this.id, // ID is crucial for re-mapping
            score: this.score,
            targetScore: this.targetScore,
            impact: this.impact,
            loe: this.loe,
            evidence: this.evidence,
            poc: this.poc,
            targetDate: this.targetDate,
            notes: this.notes,
            relevant: this.relevant // === NEW v1.6 ===
        };
    }

    /**
     * Encapsulated logic.
     * Replaces utils.calculatePriority(impact, loe)
     */
    calculatePriority() {
        const impactVal = parseInt(this.impact, 10);
        const loeVal = parseInt(this.loe, 10);
        if (!impactVal || !loeVal || impactVal < 1 || loeVal < 1) {
            return "-";
        }
        return impactVal + (4 - loeVal); // Formula: Impact + (4 - LOE)
    }

    /**
     * Parses a score string/number/null into an integer or null.
     */
    parseScore(scoreValue) {
        if (scoreValue === null || scoreValue === undefined) {
            return null;
        }
        const intScore = parseInt(scoreValue, 10);
        return isNaN(intScore) ? null : intScore;
    }
}

/**
 * Represents an Objective, which contains a list of Practices.
 */
class Objective {
    id;
    name;
    practices = []; // This will be an array of Practice instances

    constructor(staticData) {
        this.id = staticData.id;
        this.name = staticData.name;
        // Create Practice instances for each practice in the static data
        this.practices = staticData.practices.map(pData => new Practice(pData));
    }

    loadUserData(savedObjective) {
        // Create a map for efficient lookup
        const practiceMap = new Map();
        if (savedObjective.practices) {
            savedObjective.practices.forEach(pData => practiceMap.set(pData.id, pData));
        }

        // Tell each Practice instance to load its user data
        for (const practice of this.practices) {
            const savedPractice = practiceMap.get(practice.id);
            if (savedPractice) {
                practice.loadUserData(savedPractice);
            }
        }
    }

    serialize() {
        return {
            id: this.id,
            practices: this.practices.map(p => p.serialize())
        };
    }
    
    /**
     * Calculates the aggregate scores for all practices in this objective.
     * --- MODIFIED v1.6 ---
     * This logic now correctly checks for null scores AND practice.relevant.
     */
    calculateScores() {
        let totalScore = 0;
        let totalMax = 0;
        let totalAssessed = 0;
        let totalPractices = 0; // === MODIFIED v1.6: Will only count relevant practices
        
        for (const practice of this.practices) {
            // === NEW v1.6: Skip irrelevant practices ===
            if (!practice.relevant) continue;
            
            totalPractices++; // Count this relevant practice

            const currentScore = practice.parseScore(practice.score);
            const maxScore = parseInt(practice.max, 10) || 0;

            totalMax += maxScore;

            if (currentScore !== null) {
                totalAssessed++;
                totalScore += currentScore;
            }
        }
        
        const percent = totalMax > 0 ? (totalScore / totalMax) * 100 : 0;
        const assessmentCompletion = totalPractices > 0 ? (totalAssessed / totalPractices) * 100 : 0;
        
        return {
            totalScore,
            totalMax,
            totalAssessed,
            totalPractices,
            percent,
            assessmentCompletion
        };
    }

    /**
     * Groups practices by their CTI maturity level.
     */
    getPracticesByMaturity() {
        const groups = { 'CTI 1': [], 'CTI 2': [], 'CTI 3': [], 'Other': [] };
        
        for (const practice of this.practices) {
            let maturityKey = (practice.maturity || '').replace(/\s+/g, ' ').toUpperCase();
            if (maturityKey.startsWith('CTI1')) maturityKey = 'CTI 1';
            else if (maturityKey.startsWith('CTI2')) maturityKey = 'CTI 2';
            else if (maturityKey.startsWith('CTI3')) maturityKey = 'CTI 3';
            else maturityKey = 'Other';
            
            groups[maturityKey].push(practice);
        }
        return groups;
    }
}

/**
 * Represents a Domain, which contains Objectives.
 * This is the top-level model for each domain.
 */
class Domain {
    id;
    name; // The full "nan" name from the source
    nickname;
    max;
    objectives = []; // This will be an array of Objective instances

    // --- User Data (with defaults) ---
    date = '';
    relevant = true;

    constructor(staticDomain, objectivesData) {
        this.id = staticDomain.id;
        this.name = staticDomain.name;
        this.nickname = staticDomain.nickname;
        this.max = staticDomain.max;

        // Build Objective instances
        if (objectivesData) {
            const objectiveKeys = Object.keys(objectivesData).sort();
            this.objectives = objectiveKeys.map(key => new Objective(objectivesData[key]));
        }
    }
    
    loadUserData(savedDomain) {
        if (savedDomain.date !== undefined) this.date = savedDomain.date;
        if (savedDomain.relevant !== undefined) this.relevant = savedDomain.relevant;

        const objectiveMap = new Map();
        if (savedDomain.objectives) {
            savedDomain.objectives.forEach(oData => objectiveMap.set(oData.id, oData));
        }

        for (const objective of this.objectives) {
            const savedObjective = objectiveMap.get(objective.id);
            if (savedObjective) {
                objective.loadUserData(savedObjective);
            }
        }
    }

    serialize() {
        return {
            // We don't need to save the ID, as it will be the
            // key in the top-level assessmentData object.
            date: this.date,
            relevant: this.relevant,
            objectives: this.objectives.map(o => o.serialize())
        };
    }
    
    /**
     * Finds a practice instance by its ID within this domain.
     */
    getPracticeById(practiceId) {
        for (const objective of this.objectives) {
            for (const practice of objective.practices) {
                if (practice.id === practiceId) {
                    return { practice, objective };
                }
            }
        }
        return { practice: null, objective: null };
    }
    
    /**
     * Calculates the aggregate scores for all practices in this domain.
     * --- MODIFIED v1.6 ---
     * This logic now correctly checks for null scores AND practice.relevant.
     */
    calculateScores() {
        let totalScore = 0;
        let totalMax = 0;
        let totalTargetScore = 0;
        let totalAssessed = 0;
        let totalPractices = 0; // === MODIFIED v1.6: Will only count relevant practices

        for (const objective of this.objectives) {
            for (const practice of objective.practices) {
                // === NEW v1.6: Skip irrelevant practices ===
                if (!practice.relevant) continue;

                totalPractices++; // Count this relevant practice
                
                // Get the raw scores, not the "calculated" ones from getScores()
                const currentScore = practice.parseScore(practice.score);
                const targetScore = practice.parseScore(practice.targetScore);
                const maxScore = parseInt(practice.max, 10) || 0;
                
                totalMax += maxScore;

                if (currentScore !== null) {
                    totalAssessed++;
                    totalScore += currentScore;
                }
                
                // Only add to target total if a target has been explicitly set
                if (targetScore !== null) {
                    totalTargetScore += targetScore;
                }
            }
        }
        
        const percent = totalMax > 0 ? (totalScore / totalMax) * 100 : 0;
        const targetPercent = totalMax > 0 ? (totalTargetScore / totalMax) * 100 : 0;
        const assessmentCompletion = totalPractices > 0 ? (totalAssessed / totalPractices) * 100 : 0;
        
        return { 
            relevant: this.relevant, 
            totalScore, 
            totalMax, 
            percent, 
            totalTargetScore, 
            targetPercent, 
            assessmentCompletion, 
            totalAssessed, 
            totalPractices 
        };
    }
}


// ========================================================================
// === CTI-CMM APPLICATION MODULE =========================================
// ========================================================================

    /**
     * CTI-CMM Assessment Tool Application Module.
     * Encapsulates all application logic to prevent global scope pollution.
     */
    const CTICMMTool = (() => {
        'use strict';

        // --- 1. Constants ---
        const CURRENT_TOOL_VERSION = '1.6'; // === BUMPED VERSION ===
        const STORAGE_KEY = 'ctiCmmAssessmentData';
        const MODE_STORAGE_KEY = 'ctiCmmAppMode';
        const VIEW_STORAGE_KEY = 'ctiCmmAppView'; 
        const ASSESSMENT_NAME_KEY = 'ctiCmmAssessmentName';

        // Helper to patch domain names
        const DOMAIN_NAME_MAP = {
            "ASSET": "Asset, Change, and Configuration Management",
            "THREAT": "Threat and Vulnerability Management",
            "RISK": "Risk Management",
            "ACCESS": "Identity and Access Management",
            "SITUATION": "Situational Awareness",
            "RESPONSE": "Event and Incident Response, Continuity of Operations",
            "THIRD-PARTIES": "Third-Party Risk Management",
            "FRAUD": "Fraud and Abuse Management",
            "WORKFORCE": "Workforce Management",
            "ARCHITECTURE": "Cybersecurity Architecture",
            "PROGRAM": "Cybersecurity Program Management"
        };
        
        const SCORE_LEVELS = [
            { value: 0, title: "Not Implemented" },
            { value: 1, title: "Partially Implemented" },
            { value: 2, title: "Largely Implemented" },
            { value: 3, title: "Fully Implemented" }
        ];

        const IMPACT_OPTIONS = [
            { value: 1, text: "1-Low" }, { value: 2, text: "2-Med" }, { value: 3, text: "3-High" }
        ];


        // --- 2. Application State ---
        // Private state for the entire application
        let state = {
            /**
             * @type {Object<string, Domain>}
             */
            assessmentData: {}, // This will hold { "ASSET": Domain, "THREAT": Domain, ... }
            appMode: 'benchmark', // 'benchmark' or 'planning'
            prioritySort: { column: 'priority', direction: 'desc' },
            activePage: 'home',
            activeDomain: null,
            assessmentName: '',
            chartInstances: {
                radar: null,
                doughnut: null
            }
        };


        // --- 3. DOM Element Cache ---
        // Cache frequently accessed static DOM elements
        const dom = {
            mainNav: document.getElementById('main-nav'),
            mainContent: document.getElementById('main-content'),
            modeToggle: document.getElementById('mode-toggle'),
            resetData: document.getElementById('reset-data'),
            domainNav: document.getElementById('domain-nav'),
            assessmentNameInput: document.getElementById('assessment-name'),
            exportButton: document.getElementById('export-json'),
            importButton: document.getElementById('import-json'),
            // Page containers
            pageHome: document.getElementById('page-home'),
            pageDashboard: document.getElementById('page-dashboard'),
            pageAssessment: document.getElementById('page-assessment'),
            pagePriorities: document.getElementById('page-priorities'),
            // === NEW: About Page ===
            pageAbout: document.getElementById('page-about'),
            // Other elements
            assessmentTitle: document.getElementById('assessment-title'),
            assessmentDate: document.getElementById('assessment-date'),
            assessmentRelevant: document.getElementById('assessment-relevant'),
            assessmentSummary: document.getElementById('assessment-summary'),
            assessmentObjectivesContainer: document.getElementById('assessment-objectives-container'),
            assessmentDisabledBanner: document.getElementById('assessment-disabled-banner'),
            dashboardTableBody: document.getElementById('dashboard-table-body'),
            dashboardTableFooter: document.getElementById('dashboard-table-footer'),
            prioritiesTableBody: document.getElementById('priorities-table-body')
        };


        // --- 4. Utility Functions (utils) ---
        // Pure functions for calculations and data transformations
        const utils = {
            /**
             * Gets a specific parameter from the URL query string.
             */
            getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                const results = regex.exec(location.search);
                return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, ' '));
            },

            /**
             * Parses a score from the data model.
             * Returns null if unset (null, undefined), otherwise returns the integer value.
             */
            parseScore(score) {
                if (score === null || score === undefined) {
                    return null;
                }
                const intScore = parseInt(score, 10);
                return isNaN(intScore) ? null : intScore;
            },

            /**
             * Calculates scores for all domains and totals.
             * --- MODIFIED v1.6 ---
             * This function now implicitly uses the updated Domain.calculateScores()
             * which correctly accounts for practice.relevant. No code change
             * is needed *here* as the logic is correctly encapsulated in the Domain class.
             */
            calculateAllScores() {
                let grandTotalScore = 0;
                let grandTotalMax = 0;
                let grandTotalTargetScore = 0;
                let grandTotalAssessed = 0;
                let grandTotalPractices = 0; // Only count *relevant* practices from *relevant* domains

                const domainScores = window.CMM_DATA.domains.map(domainData => {
                    const domainInstance = state.assessmentData[domainData.id];
                    const scores = domainInstance.calculateScores(); // This now returns scores for *relevant* practices
                    
                    if (scores.relevant) { // Only add to totals if domain is relevant
                        grandTotalScore += scores.totalScore;
                        grandTotalMax += scores.totalMax;
                        grandTotalTargetScore += scores.totalTargetScore;
                        grandTotalAssessed += scores.totalAssessed;
                        grandTotalPractices += scores.totalPractices; // This is now the count of *relevant* practices
                    }
                    // Combine static data (nickname) with calculated scores
                    return { ...domainData, ...scores }; 
                });

                const overallPercent = grandTotalMax > 0 ? (grandTotalScore / grandTotalMax) * 100 : 0;
                const overallTargetPercent = grandTotalMax > 0 ? (grandTotalTargetScore / grandTotalMax) * 100 : 0;
                const overallAssessmentCompletion = grandTotalPractices > 0 ? (grandTotalAssessed / grandTotalPractices) * 100 : 0;

                return { 
                    domainScores, 
                    grandTotalScore, 
                    grandTotalMax, 
                    grandTotalTargetScore, 
                    overallPercent, 
                    overallTargetPercent,
                    overallAssessmentCompletion,
                    grandTotalAssessed,
                    grandTotalPractices
                };
            },

            /**
             * Escapes a string for use in a CSV file.
             */
            escapeCSV(str) {
                if (str === null || str === undefined) {
                    return '""';
                }
                let result = String(str);
                
                // --- SECURE MODIFICATION: Prevent CSV Injection ---
                // Prepend a single quote if the string starts with a formula character
                if (['=', '+', '-', '@'].includes(result.charAt(0))) {
                    result = "'" + result;
                }
                // --- END MODIFICATION ---

                if (result.includes('"') || result.includes(',') || result.includes('\n')) {
                    result = result.replace(/"/g, '""'); // Escape quotes
                    result = `"${result}"`; // Wrap in quotes
                }
                return result;
            }
        };


        // --- 5. State Management (store) ---
        // Functions that mutate state and handle persistence
        const store = {
            /**
             * Finds a Practice instance by its ID from anywhere in the state.
             */
            getPracticeInstanceById(practiceId) {
                for (const domainKey in state.assessmentData) {
                    const domain = state.assessmentData[domainKey];
                    const { practice, objective } = domain.getPracticeById(practiceId);
                    if (practice) {
                        return { practice, domain, objective };
                    }
                }
                return { practice: null, domain: null, objective: null };
            },

            /**
             * Gets the user-editable data object, ready for saving or exporting.
             * This is now just a loop that calls .serialize() on each Domain instance.
             */
            getUserDataForSave() {
                const dataToSave = {}; 
                for (const domainId in state.assessmentData) {
                    const domainInstance = state.assessmentData[domainId];
                    dataToSave[domainId] = domainInstance.serialize();
                }
                return dataToSave;
            },

            /**
             * Saves only the user-editable data to localStorage.
             */
            saveState() {
                try {
                    const dataToSave = store.getUserDataForSave();
                    const savedString = JSON.stringify(dataToSave);
                    localStorage.setItem(STORAGE_KEY, savedString);
                    console.log('User assessment data saved.');
                } catch (error) {
                    console.error('Error saving data to localStorage:', error);
                }
            },

            /**
             * Saves the current app mode to localStorage.
             */
            saveMode() {
                try {
                    localStorage.setItem(MODE_STORAGE_KEY, state.appMode);
                    console.log('App mode saved.');
                } catch (e) {
                    console.warn('localStorage write failed (mode):', e.message);
                }
            },

            /**
             * Saves the current assessment name to localStorage.
             */
            saveAssessmentName() {
                try {
                    localStorage.setItem(ASSESSMENT_NAME_KEY, state.assessmentName);
                    console.log('Assessment name saved.');
                } catch (e) {
                    console.warn('localStorage write failed (name):', e.message);
                }
            },

            /**
             * Loads all data and mode from localStorage into the state.
             * This is now refactored to use the Domain class .loadUserData() method.
             */
            loadState() {
                // Load app mode
                try {
                    state.appMode = localStorage.getItem(MODE_STORAGE_KEY) || 'benchmark';
                } catch (e) {
                    console.warn('localStorage read failed (mode):', e.message);
                    state.appMode = 'benchmark';
                }
                dom.modeToggle.checked = (state.appMode === 'planning');

                // Load Assessment Name
                try {
                    state.assessmentName = localStorage.getItem(ASSESSMENT_NAME_KEY) || '';
                    dom.assessmentNameInput.value = state.assessmentName;
                } catch (e) {
                    console.warn('localStorage read failed (name):', e.message);
                    state.assessmentName = '';
                }
                
                // 1. Get the fresh, authoritative class instances
                state.assessmentData = store.getDefaultAssessmentData();
                
                // 2. Load the user's saved progress
                let userProgress = {};
                try {
                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        // Use a reviver to prevent prototype pollution
                        userProgress = JSON.parse(savedData, (key, value) => {
                            if (key === '__proto__') return undefined;
                            return value;
                        });
                        console.log('User progress loaded.');
                    } else {
                        console.log('No saved data found.');
                    }
                } catch (error) {
                    console.error('Error loading user data from localStorage:', error);
                    userProgress = {};
                }

                // 3. Manually merge userProgress *into* the class instances
                // This is now clean, just tell each domain instance to load its data.
                for (const domainId in state.assessmentData) {
                    const domainInstance = state.assessmentData[domainId];
                    const userDomainData = userProgress[domainId];
                    if (domainInstance && userDomainData) {
                        domainInstance.loadUserData(userDomainData);
                    }
                }
                
                console.log('Assessment data loaded and merged into class instances.');
            },

            /**
             * Builds the initial state from the loaded CMM_DATA.
             * This now creates and returns a map of Domain instances.
             */
            getDefaultAssessmentData() {
                /** @type {Object<string, Domain>} */
                const defaultData = {};
                
                window.CMM_DATA.domains.forEach(staticDomain => {
                    const domainId = staticDomain.id;
                    const objectivesFromData = window.CMM_DATA.objectives[domainId];
                    
                    // Create a new Domain instance which will in turn
                    // create all its Objective and Practice instances.
                    defaultData[domainId] = new Domain(staticDomain, objectivesFromData);
                });
                
                return defaultData;
            },

            /**
             * Clears all data from localStorage and reloads.
             */
            resetData() {
                if (confirm('Are you sure you want to reset all assessment data? This action cannot be undone.')) {
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(VIEW_STORAGE_KEY); 
                    localStorage.removeItem(ASSESSMENT_NAME_KEY);
                    location.reload();
                }
            },

            // --- State Mutator Functions ---

            /**
             * Updates a field for a specific practice and saves the state.
             */
            updatePracticeField(practiceId, field, value) {
                const { practice, domain, objective } = store.getPracticeInstanceById(practiceId);
                if (practice) {
                    // Update the property on the class instance
                    practice[field] = value;
                    store.saveState();
                    return { practice, domain, objective }; // Return context
                }
                return null;
            },
            
            /**
             * Updates a metadata field for a domain (e.g., date, relevant) and saves.
             */
            updateDomainMeta(domainId, field, value) {
                const domainInstance = state.assessmentData[domainId];
                if (domainInstance) {
                    domainInstance[field] = value;
                    store.saveState();
                    return true;
                }
                return false;
            },

            /**
             * Sets the application mode and saves it.
             */
            setAppMode(mode) {
                state.appMode = mode;
                store.saveMode();
            },

            /**
             * Updates the active page/domain in the state.
             */
            setActivePage(pageId, domainId = null) {
                state.activePage = pageId;
                state.activeDomain = domainId;
            },

            /**
             * Updates the priority sorting state.
             */
            setPrioritySort(column, direction) {
                state.prioritySort = { column, direction };
            }
        };


        // --- 6. View / Rendering Functions (view) ---
        // All functions that read state and manipulate the DOM
        const view = {
            /**
             * Main page router. Hides all pages and shows the target one.
             */
            showPage(pageId, domainId = null, fromPopState = false) {
                store.setActivePage(pageId, domainId);
                
                // Save current view to localStorage for next session
                try {
                    const viewToSave = JSON.stringify({ page: pageId, domain: domainId });
                    localStorage.setItem(VIEW_STORAGE_KEY, viewToSave);
                } catch (e) {
                    console.warn('localStorage write failed (view):', e.message);
                }
                
                // === NEW CODE: Update Browser History ===
                if (!fromPopState) {
                    const stateObj = { page: pageId, domain: domainId };
                    let title = "CTI-CMM Assessment Tool";
                    let url = window.location.pathname; // Get base path (e.g., /index.html)

                    // Create the new URL
                    if (pageId === 'assessment' && domainId) {
                        title = `${domainId} - ${title}`;
                        url += `?domain=${domainId}`;
                    } else if (pageId !== 'home') {
                        title = `${pageId.charAt(0).toUpperCase() + pageId.slice(1)} - ${title}`;
                        url += `?page=${pageId}`;
                    }
                    
                    // Only push state if the URL is actually different
                    const fullUrl = window.location.origin + url;
                    if (fullUrl !== window.location.href) {
                         window.history.pushState(stateObj, title, url);
                    }
                    document.title = title; // Also update the document title
                } else {
                    // Even on popstate, update the document title
                    let title = "CTI-CMM Assessment Tool";
                    if (pageId === 'assessment' && domainId) {
                        title = `${domainId} - ${title}`;
                    } else if (pageId !== 'home') {
                        title = `${pageId.charAt(0).toUpperCase() + pageId.slice(1)} - ${title}`;
                    }
                    document.title = title;
                }
                // === END NEW CODE ===

                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.style.display = 'none';
                });
                
                // Show the target page
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.style.display = 'block';
                }

                // Update nav active state
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === pageId && (!domainId || link.dataset.domain === domainId)) {
                        link.classList.add('active');
                    }
                });

                // Call render functions for the specific page
                switch (pageId) {
                    case 'home':
                        view.renderHomePage();
                        break;
                    case 'dashboard':
                        view.renderDashboardPage();
                        break;
                    case 'assessment':
                        if (domainId) {
                            view.renderAssessmentPage(domainId);
                        }
                        break;
                    case 'priorities':
                        view.renderPrioritiesPage();
                        break;
                    // === NEW: About Page ===
                    case 'about':
                        view.renderAboutPage();
                        break;
                }
            },

            renderHomePage() {
                // Static content, nothing to render
            },
            
            // === NEW: About Page Renderer ===
            renderAboutPage() {
                // Static content, nothing to render
            },

            /**
             * Renders the dashboard page.
             * --- MODIFIED v1.6 ---
             * This function now implicitly uses utils.calculateAllScores()
             * which correctly accounts for practice.relevant. No code change
             * is needed *here* as the logic is correctly encapsulated.
             */
            renderDashboardPage() {
                const { 
                    domainScores, 
                    grandTotalScore, 
                    grandTotalMax, 
                    overallPercent, 
                    overallTargetPercent,
                    overallAssessmentCompletion,
                    grandTotalAssessed,
                    grandTotalPractices
                } = utils.calculateAllScores();
                
                // 1. Populate Table
                dom.dashboardTableBody.innerHTML = ''; // Clear old data
                domainScores.forEach(domain => {
                    const domainName = DOMAIN_NAME_MAP[domain.id] || domain.nickname;
                    const rowClass = domain.relevant ? "hover:bg-slate-50" : "hover:bg-slate-50 opacity-50 line-through";
                    // SECURE: All data here is either from our own map or a calculation.
                    const row = `
                        <tr class="${rowClass}">
                            <td class="py-4 px-6 text-sm font-medium text-slate-900">${domainName}</td>
                            <td class="py-4 px-6 text-sm text-slate-500">${domain.totalScore}</td>
                            <td class="py-4 px-6 text-sm text-slate-500">${domain.totalMax}</td>
                            <td class="py-4 px-6 text-sm text-slate-500">
                                <div class="w-full bg-slate-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${domain.percent.toFixed(0)}%"></div>
                                </div>
                                <span class="text-xs">${domain.percent.toFixed(1)}%</span>
                            </td>
                            <td class="py-4 px-6 text-sm text-slate-500">
                                <div class="w-full bg-slate-200 rounded-full h-2.5">
                                    <div class="bg-green-600 h-2.5 rounded-full" style="width: ${domain.targetPercent.toFixed(0)}%"></div>
                                </div>
                                <span class="text-xs">${domain.targetPercent.toFixed(1)}%</span>
                            </td>
                        </tr>
                    `;
                    dom.dashboardTableBody.innerHTML += row;
                });

                // 2. Populate Table Footer
                dom.dashboardTableFooter.innerHTML = `
                    <td class="py-4 px-6 text-sm">Total (Relevant Domains & Practices)</td>
                    <td class="py-4 px-6 text-sm">${grandTotalScore}</td>
                    <td class="py-4 px-6 text-sm">${grandTotalMax}</td>
                    <td class="py-4 px-6 text-sm">${overallPercent.toFixed(1)}%</td>
                    <td class="py-4 px-6 text-sm">${overallTargetPercent.toFixed(1)}%</td>
                `;

                // 3. Render Radar Chart
                const radarCtx = document.getElementById('maturityRadarChart').getContext('2d');
                if (state.chartInstances.radar) {
                    state.chartInstances.radar.destroy();
                }
                state.chartInstances.radar = new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels: domainScores.map(d => d.nickname),
                        datasets: [
                            {
                                label: 'Current Maturity %',
                                data: domainScores.map(d => d.relevant ? d.percent : 0),
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                            },
                            {
                                label: 'Target Maturity %',
                                data: domainScores.map(d => d.relevant ? d.targetPercent : 0),
                                backgroundColor: 'rgba(22, 163, 74, 0.2)',
                                borderColor: 'rgba(22, 163, 74, 1)',
                                borderWidth: 2,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 20 } } }
                    }
                });

                // 4. Render Doughnut Chart
                const doughnutCtx = document.getElementById('overallProgressDoughnut').getContext('2d');
                if (state.chartInstances.doughnut) {
                    state.chartInstances.doughnut.destroy();
                }
                state.chartInstances.doughnut = new Chart(doughnutCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Assessed', 'Not Assessed'],
                        datasets: [{
                            data: [grandTotalAssessed, grandTotalPractices - grandTotalAssessed],
                            backgroundColor: ['rgba(59, 130, 246, 1)', 'rgba(229, 231, 235, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false },
                            title: {
                                display: true,
                                text: `${overallAssessmentCompletion.toFixed(1)}%`,
                                font: { size: 40, weight: 'bold' },
                                color: '#1e293b'
                            },
                            subtitle: {
                                display: true,
                                text: 'Overall Assessment (Relevant Items)',
                                font: { size: 16 },
                                color: '#64748b',
                                padding: { bottom: 30 }
                            }
                        }
                    }
                });
            },

            /**
             * Renders the main assessment page for a given domain.
             * SECURE: Uses .textContent for all untrusted data (slug, text).
             * --- MODIFIED v1.6 ---
             * Added relevance toggle to each practice.
             * Added .content-disabled to widget rows if practice.relevant is false.
             */
            renderAssessmentPage(domainId) {
                const domain = state.assessmentData[domainId];
                if (!domain) {
                    console.error('Domain instance not found:', domainId);
                    return;
                }

                dom.assessmentTitle.textContent = DOMAIN_NAME_MAP[domain.id] || domain.nickname;
                dom.assessmentDate.value = domain.date;
                dom.assessmentRelevant.checked = domain.relevant;
                
                view.updateAssessmentSummary(domainId); // Render summary

                // Handle relevance toggle
                if (domain.relevant) {
                    dom.assessmentObjectivesContainer.classList.remove('content-disabled');
                    dom.assessmentDisabledBanner.classList.add('hidden');
                } else {
                    dom.assessmentObjectivesContainer.classList.add('content-disabled');
                    dom.assessmentDisabledBanner.classList.remove('hidden');
                }
                
                dom.assessmentObjectivesContainer.innerHTML = ''; // Clear old data

                domain.objectives.forEach((objective) => {
                    const details = document.createElement('details');
                    details.className = "bg-white rounded-lg shadow-md overflow-hidden";
                    details.open = true; // Open by default
                    
                    const summary = document.createElement('summary');
                    summary.className = "cursor-pointer bg-slate-100 p-4 font-semibold text-lg hover:bg-slate-200 flex justify-between";
                    summary.textContent = objective.name; // Safe (from our class)
                    details.appendChild(summary);

                    // Group practices by maturity
                    const practicesByMaturity = objective.getPracticesByMaturity();

                    const maturityGroupsContainer = document.createElement('div');
                    maturityGroupsContainer.className = "p-4 space-y-4";

                    // Loop over CTI 1, CTI 2, CTI 3 and render tables
                    for (const maturityLevel of ['CTI 1', 'CTI 2', 'CTI 3', 'Other']) {
                        const practices = practicesByMaturity[maturityLevel];
                        if (!practices || practices.length === 0) continue;
                        
                        const groupHeader = document.createElement('h4');
                        groupHeader.className = "text-md font-semibold text-slate-700 pt-2";
                        let maturityName = "Uncategorized";
                        if (maturityLevel === 'CTI 1') maturityName = "Foundational";
                        if (maturityLevel === 'CTI 2') maturityName = "Intermediate";
                        if (maturityLevel === 'CTI 3') maturityName = "Advanced";
                        groupHeader.textContent = `${maturityLevel} - ${maturityName}`;
                        maturityGroupsContainer.appendChild(groupHeader);
                        
                        const tableContainer = document.createElement('div');
                        tableContainer.className = "overflow-x-auto border rounded-md";
                        const table = document.createElement('table');
                        table.className = "min-w-full assessment-table";
                        const tbody = document.createElement('tbody');
                        tbody.className = "bg-white";

                        practices.forEach(practice => {
                            // Row 1: Practice Info
                            const rowInfo = document.createElement('tr');
                            rowInfo.className = "bg-slate-50";
                            // --- SECURE MODIFICATION: Use .textContent for untrusted data ---
                            const cellInfo = document.createElement('td');
                            cellInfo.colSpan = 5;
                            // === MODIFIED v1.6: Added relative positioning ===
                            cellInfo.className = "pt-4 pb-2 px-4 border-b-0 relative";

                            // === NEW v1.6: Add Practice Relevance Toggle ===
                            const toggleContainer = document.createElement('div');
                            toggleContainer.className = "absolute top-4 right-4";
                            toggleContainer.innerHTML = `
                                <label class="flex items-center cursor-pointer">
                                    <span class="text-xs font-medium text-slate-600 mr-2">Relevant</span>
                                    <div class="relative">
                                        <input type="checkbox" class="sr-only peer practice-relevance-toggle" data-id="${practice.id}" data-field="relevant" ${practice.relevant ? 'checked' : ''}>
                                        <div class="w-11 h-6 bg-slate-400 rounded-full peer-checked:bg-blue-600"></div>
                                        <div class="absolute top-0.5 left-[2px] bg-white w-5 h-5 rounded-full transition-all peer-checked:translate-x-full"></div>
                                    </div>
                                </label>
                            `;
                            cellInfo.appendChild(toggleContainer);
                            // === END NEW v1.6 ===

                            const slugDiv = document.createElement('div');
                            slugDiv.className = "font-semibold text-slate-800 pr-32"; // Added padding-right
                            slugDiv.textContent = practice.slug; // Safe
                            
                            if (!practice.relevant) {
                                slugDiv.classList.add('line-through', 'text-slate-400');
                            }
                            
                            cellInfo.appendChild(slugDiv);

                            const textDiv = document.createElement('div');
                            textDiv.className = "text-slate-600 mt-1 pr-32"; // Added padding-right
                            textDiv.textContent = practice.text; // Safe
                            
                            if (!practice.relevant) {
                                textDiv.classList.add('line-through', 'text-slate-400');
                            }
                            
                            cellInfo.appendChild(textDiv);
                            
                            rowInfo.appendChild(cellInfo);
                            // --- END MODIFICATION ---
                            tbody.appendChild(rowInfo);

                            // Row 2: Top Widgets
                            const rowWidgets1 = document.createElement('tr');
                            // === NEW v1.6: Add dataset and class for disabling ===
                            rowWidgets1.dataset.practiceRowId = practice.id;
                            if (!practice.relevant) rowWidgets1.classList.add('content-disabled');
                            
                            // Col 1: Current Maturity
                            const cellCurrent = document.createElement('td');
                            cellCurrent.className = "pb-2 pl-4 w-[180px]";
                            cellCurrent.innerHTML = `<div class="widget-label" title="Your current score">Current level</div>`;
                            cellCurrent.appendChild(view.createCurrentMaturityWidget(practice));
                            rowWidgets1.appendChild(cellCurrent);

                            // Col 2: Evidence
                            const cellEvidence = document.createElement('td');
                            cellEvidence.className = "pb-2 w-[20%]";
                            cellEvidence.innerHTML = `<div class="widget-label">Evidence</div>`;
                            cellEvidence.appendChild(view.createInput('text', practice.evidence, practice.id, 'evidence', 'Link/doc...'));
                            rowWidgets1.appendChild(cellEvidence);
                            
                            // Col 5: Notes
                            const cellNotes = document.createElement('td');
                            cellNotes.className = "pb-2 pr-4 w-auto h-full"; 
                            cellNotes.innerHTML = `<div class="widget-label">Notes</div>`;
                            const notesTextarea = view.createTextarea(practice.notes, practice.id, 'notes', 'Reasoning...');
                            notesTextarea.rows = 2;
                            notesTextarea.className = "p-1 border rounded-md w-full h-full min-h-[4rem]";
                            cellNotes.appendChild(notesTextarea);
                            
                            if (state.appMode === 'planning') {
                                // --- PLANNING MODE (Row 1) ---
                                const cellPoc = document.createElement('td');
                                cellPoc.className = "pb-2 w-[20%]";
                                cellPoc.innerHTML = `<div class="widget-label" title="Point of Contact...">Point of Contact</div>`;
                                cellPoc.appendChild(view.createInput('text', practice.poc, practice.id, 'poc', 'Name/team...'));
                                rowWidgets1.appendChild(cellPoc);
                                
                                const cellBlank = document.createElement('td');
                                cellBlank.className = "pb-2 w-[120px]";
                                cellBlank.innerHTML = `<div class="widget-label">&nbsp;</div>`;
                                rowWidgets1.appendChild(cellBlank);

                            } else {
                                // --- BENCHMARK MODE ---
                                const cellPoc = document.createElement('td');
                                cellPoc.className = "pb-2 w-[20%]";
                                cellPoc.colSpan = 2; // Span over Impact/Priority columns
                                cellPoc.innerHTML = `<div class="widget-label" title="Point of Contact...">Point of Contact</div>`;
                                cellPoc.appendChild(view.createInput('text', practice.poc, practice.id, 'poc', 'Name/team...'));
                                rowWidgets1.appendChild(cellPoc);
                            }
                            rowWidgets1.appendChild(cellNotes);
                            tbody.appendChild(rowWidgets1);

                            // Row 3: Bottom Widgets (Planning ONLY)
                            if (state.appMode === 'planning') {
                                const rowWidgets2 = document.createElement('tr');
                                // === NEW v1.6: Add dataset and class for disabling ===
                                rowWidgets2.dataset.practiceRowId = practice.id;
                                if (!practice.relevant) rowWidgets2.classList.add('content-disabled');

                                const cellTarget = document.createElement('td');
                                cellTarget.className = "pb-4 pl-4 w-[180px]";
                                cellTarget.innerHTML = `<div class="widget-label" title="Your target score">Target level</div>`;
                                
                                const targetWidget = view.createTargetMaturityWidget(practice); // Create it
                                view.checkTargetScoreWarning(practice, targetWidget); // Check it
                                cellTarget.appendChild(targetWidget); // Append it
                                
                                rowWidgets2.appendChild(cellTarget);

                                const cellTargetDate = document.createElement('td');
                                cellTargetDate.className = "pb-4 w-[20%]";
                                cellTargetDate.innerHTML = `<div class="widget-label">Target Date</div>`;
                                cellTargetDate.appendChild(view.createInput('date', practice.targetDate, practice.id, 'targetDate'));
                                rowWidgets2.appendChild(cellTargetDate);

                                const cellImpact = document.createElement('td');
                                cellImpact.className = "pb-4 w-[20%]";
                                cellImpact.innerHTML = `<div class="widget-label" title="What will this measure mean for business gains..._">Impact</div>`;
                                cellImpact.appendChild(view.createSelect(IMPACT_OPTIONS, practice.impact, practice.id, 'impact'));
                                rowWidgets2.appendChild(cellImpact);
                                
                                const cellLoe = document.createElement('td');
                                cellLoe.className = "pb-4 w-[120px]";
                                cellLoe.innerHTML = `<div class="widget-label" title="Represents level of effort required...">Effort</div>`;
                                cellLoe.appendChild(view.createSelect(IMPACT_OPTIONS, practice.loe, practice.id, 'loe'));
                                rowWidgets2.appendChild(cellLoe);

                                const cellPriority = document.createElement('td');
                                cellPriority.className = "pb-4 pr-4 w-auto";
                                cellPriority.innerHTML = `<div class="widget-label">Priority</div>`;
                                const priorityDisplay = document.createElement('div');
                                priorityDisplay.className = "p-1 font-bold text-slate-700 text-lg text-left";
                                priorityDisplay.dataset.priorityId = practice.id;
                                // Use the class method to calculate
                                priorityDisplay.textContent = practice.calculatePriority();
                                cellPriority.appendChild(priorityDisplay);
                                rowWidgets2.appendChild(cellPriority);
                                
                                tbody.appendChild(rowWidgets2);
                            }
                        });
                        
                        table.appendChild(tbody);
                        tableContainer.appendChild(table);
                        maturityGroupsContainer.appendChild(tableContainer);
                    }

                    details.appendChild(maturityGroupsContainer);

                    // Add the subtotal element
                    // === MODIFIED v1.6: This calculation now respects practice.relevant ===
                    const { 
                        totalScore: objTotalScore, 
                        totalMax: objTotalMax,
                        totalAssessed: objTotalAssessed,
                        totalPractices: objTotalPractices, // This is now count of *relevant* practices
                        percent: objPercent,
                        assessmentCompletion: objCompletion
                    } = objective.calculateScores();
                    
                    const subtotalEl = document.createElement('div');
                    subtotalEl.className = "bg-slate-50 p-4 font-bold text-sm flex justify-end space-x-6 border-t border-slate-200";
                    subtotalEl.dataset.objectiveId = objective.name; // For live updates
                    subtotalEl.innerHTML = `
                        <span class="font-semibold">Section Subtotal:</span>
                        <span class="text-right">Completed: ${objTotalAssessed} / ${objTotalPractices} (${objCompletion.toFixed(1)}%)</span>
                        <span class="text-right">Score: ${objTotalScore} / ${objTotalMax} (${objPercent.toFixed(1)}%)</span>
                    `;
                    details.appendChild(subtotalEl);
                    dom.assessmentObjectivesContainer.appendChild(details);
                });
            },

            /**
             * Renders the priorities planning sheet.
             * --- MODIFIED v1.6 ---
             * Now filters out practices where practice.relevant is false.
             */
            renderPrioritiesPage() {
                dom.prioritiesTableBody.innerHTML = ''; // Clear old data

                let priorityItems = [];
                for (const domainId in state.assessmentData) {
                    const domain = state.assessmentData[domainId];
                    if (domain.relevant === false) continue; // Skip irrelevant domains
                    
                    domain.objectives.forEach(objective => {
                        objective.practices.forEach(practice => {
                            // === NEW v1.6: Skip irrelevant practices ===
                            if (!practice.relevant) return; 

                            const currentScore = utils.parseScore(practice.score);
                            const targetScore = utils.parseScore(practice.targetScore);
                            
                            // Only include items where target is set and (current is null or target > current)
                            if (targetScore !== null && (currentScore === null || targetScore > currentScore)) {
                                priorityItems.push({
                                    domainNickname: domain.nickname,
                                    practice: practice // Pass the whole instance
                                });
                            }
                        });
                    });
                }

                // Sort items based on the global prioritySort state
                priorityItems.sort((a, b) => {
                    const col = state.prioritySort.column;
                    const pA = a.practice;
                    const pB = b.practice;
                    let valA, valB;

                    switch (col) {
                        case 'priority':
                            valA = pA.calculatePriority();
                            valB = pB.calculatePriority();
                            if (valA === '-') valA = -Infinity;
                            if (valB === '-') valB = -Infinity;
                            break;
                        case 'impact':
                        case 'loe':
                            valA = parseInt(pA[col], 10) || 0;
                            valB = parseInt(pB[col], 10) || 0;
                            break;
                        case 'score':
                        case 'target':
                            const key = col === 'target' ? 'targetScore' : col;
                            valA = utils.parseScore(pA[key]);
                            valB = utils.parseScore(pB[key]);
                            if (valA === null) valA = -1; // Sort nulls before 0
                            if (valB === null) valB = -1;
                            break;
                        case 'date':
                            valA = pA.targetDate || '';
                            valB = pB.targetDate || '';
                            if (valA === '' && valB !== '') return 1;
                            if (valA !== '' && valB === '') return -1;
                            break;
                        case 'practice':
                            valA = (pA.slug || '').toLowerCase();
                            valB = (pB.slug || '').toLowerCase();
                            break;
                        case 'domain':
                        default:
                            valA = (a.domainNickname || '').toLowerCase();
                            valB = (b.domainNickname || '').toLowerCase();
                            break;
                    }

                    let result = 0;
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        result = valA - valB;
                    } else if (typeof valA === 'string' && typeof valB === 'string') {
                        result = valA.localeCompare(valB);
                    }
                    
                    return state.prioritySort.direction === 'desc' ? result * -1 : result;
                });
                
                view.updatePrioritySortHeaders(); // Update UI

                if (priorityItems.length === 0) {
                    const row = dom.prioritiesTableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 9;
                    cell.className = "p-6 text-center text-slate-500";
                    cell.textContent = "No priority items found from relevant domains. (Ensure 'Target' score is higher than 'Current' score on relevant practices).";
                    return;
                }

                // --- SECURE ROW RENDERING ---
                const fragment = document.createDocumentFragment();
                priorityItems.forEach(item => {
                    const practice = item.practice;
                    const priority = practice.calculatePriority();
                    
                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50";

                    // Helper to create and append a cell with text
                    const addTextCell = (text, classes) => {
                        const cell = document.createElement('td');
                        cell.className = classes;
                        cell.textContent = text; // Use .textContent to prevent XSS
                        row.appendChild(cell);
                    };

                    // Helper to create and append a cell with HTML
                    const addHTMLCell = (htmlString, classes) => {
                        const cell = document.createElement('td');
                        cell.className = classes;
                        cell.innerHTML = htmlString; // Safe for our own widget
                        row.appendChild(cell);
                    };

                    addTextCell(item.domainNickname, "py-4 px-4 text-sm font-medium text-slate-900");
                    addTextCell(practice.slug, "py-4 px-4 text-sm text-slate-700");
                    addHTMLCell(view.createDisplayMaturityWidget(practice.score, 'current'), "py-2 px-4 text-sm text-slate-500");
                    addHTMLCell(view.createDisplayMaturityWidget(practice.targetScore, 'target'), "py-2 px-4 text-sm text-slate-500");
                    addTextCell(practice.impact || '-', "py-4 px-4 text-sm text-slate-500");
                    addTextCell(practice.loe || '-', "py-4 px-4 text-sm text-slate-500");
                    addTextCell(priority, "py-4 px-4 text-sm text-slate-500 font-bold text-center");
                    addTextCell(practice.targetDate, "py-4 px-4 text-sm text-slate-500");
                    
                    const truncatedNotes = (practice.notes || '').substring(0, 50) + (practice.notes.length > 50 ? '...' : '');
                    addTextCell(truncatedNotes, "py-4 px-4 text-sm text-slate-500");

                    fragment.appendChild(row);
                });
                dom.prioritiesTableBody.appendChild(fragment);
            },
            
            // --- View Helper Functions ---

            createSelect(options, selectedValue, practiceId, field) {
                const select = document.createElement('select');
                select.className = "p-1 border rounded-md bg-white w-full";
                select.dataset.id = practiceId;
                select.dataset.field = field;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.text = opt.text;
                    if (opt.value == selectedValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                return select;
            },
            
            createInput(type, value, practiceId, field, placeholder = '') {
                const input = document.createElement('input');
                input.type = type;
                input.className = "p-1 border rounded-md w-full";
                input.value = value || '';
                input.dataset.id = practiceId;
                input.dataset.field = field;
                input.placeholder = placeholder;
                return input;
            },
            
            createTextarea(value, practiceId, field, placeholder = '') {
                const textarea = document.createElement('textarea');
                textarea.value = value || '';
                textarea.dataset.id = practiceId;
                textarea.dataset.field = field;
                textarea.placeholder = placeholder;
                return textarea;
            },

            createCurrentMaturityWidget(practice) {
                const score = utils.parseScore(practice.score);
                const widget = document.createElement('div');
                widget.className = "maturity-widget";
                widget.dataset.id = practice.id;

                SCORE_LEVELS.forEach((s, index) => {
                    const dotWrapper = document.createElement('div');
                    dotWrapper.className = "flex flex-col items-center";
                    
                    const dot = document.createElement('div');
                    dot.className = "maturity-dot";
                    dot.dataset.score = s.value;
                    dot.dataset.field = "score";
                    dot.title = s.title;

                    if (score !== null) {
                        if (s.value === score) dot.classList.add('active', 'selected');
                        else if (s.value < score) dot.classList.add('active');
                    }
                    
                    const label = document.createElement('div');
                    label.className = "maturity-label";
                    label.textContent = s.value;
                    
                    dotWrapper.appendChild(dot);
                    dotWrapper.appendChild(label);
                    widget.appendChild(dotWrapper);

                    if (index < SCORE_LEVELS.length - 1) {
                        const line = document.createElement('div');
                        line.className = "maturity-line";
                        if (score !== null && s.value < score) {
                            line.classList.add('active');
                        }
                        widget.appendChild(line);
                    }
                });
                return widget;
            },

            createTargetMaturityWidget(practice) {
                const score = utils.parseScore(practice.targetScore);
                const widget = document.createElement('div');
                widget.className = "target-widget";
                widget.dataset.id = practice.id;

                SCORE_LEVELS.forEach((s, index) => {
                    const dotWrapper = document.createElement('div');
                    dotWrapper.className = "flex flex-col items-center";
                    
                    const dot = document.createElement('div');
                    dot.className = "target-dot";
                    dot.dataset.score = s.value;
                    dot.dataset.field = "targetScore";
                    dot.title = `Target: ${s.title}`;

                    if (score !== null) {
                        if (s.value === score) dot.classList.add('active', 'selected');
                        else if (s.value < score) dot.classList.add('active');
                    }
                    
                    const label = document.createElement('div');
                    label.className = "maturity-label";
                    label.textContent = s.value;
                    
                    dotWrapper.appendChild(dot);
                    dotWrapper.appendChild(label);
                    widget.appendChild(dotWrapper);

                    if (index < SCORE_LEVELS.length - 1) {
                        const line = document.createElement('div');
                        line.className = "target-line";
                        if (score !== null && s.value < score) {
                            line.classList.add('active');
                        }
                        widget.appendChild(line);
                    }
                });
                return widget;
            },

            /**
             * Creates a non-interactive HTML string for a display widget (Priorities page).
             */
            createDisplayMaturityWidget(score, type = 'current') {
                const intScore = utils.parseScore(score);
                const baseClass = type === 'current' ? 'maturity' : 'target';
                const widgetClass = type === 'current' ? 'maturity-widget' : 'target-widget';
                
                let html = `<div class="${widgetClass}" style="padding-top: 0; padding-left: 8px;">`; 
                
                SCORE_LEVELS.forEach((s, index) => {
                    const dotClasses = [`${baseClass}-dot`];
                    if (intScore !== null) {
                        if (s.value === intScore) dotClasses.push('active', 'selected');
                        else if (s.value < intScore) dotClasses.push('active');
                    }
                    
                    html += `<div class="flex flex-col items-center">`;
                    html += `<div class="${dotClasses.join(' ')}" title="${intScore === null ? 'Not Assessed' : s.title}"></div>`; 
                    html += `<div class="maturity-label">${s.value}</div>`;
                    html += `</div>`;

                    if (index < SCORE_LEVELS.length - 1) {
                        const lineClasses = [`${baseClass}-line`];
                        if (intScore !== null && s.value < intScore) {
                            lineClasses.push('active');
                        }
                        html += `<div class="${lineClasses.join(' ')}"></div>`;
                    }
                });
                
                html += `</div>`;
                return html;
            },

            /**
             * Updates the visual state of a dot widget after a click.
             */
            updateDotWidget(widgetElement, newScore) {
                const score = utils.parseScore(newScore);
                const dots = widgetElement.querySelectorAll('.maturity-dot, .target-dot');
                const lines = widgetElement.querySelectorAll('.maturity-line, .target-line');

                dots.forEach((dot, index) => {
                    dot.classList.remove('active', 'selected');
                    const dotScore = parseInt(dot.dataset.score, 10);

                    if (score !== null) {
                        if (dotScore === score) dot.classList.add('active', 'selected');
                        else if (dotScore < score) dot.classList.add('active');
                    }

                    if (index < lines.length) {
                        const line = lines[index];
                        line.classList.remove('active');
                        if (score !== null && dotScore < score) {
                            line.classList.add('active');
                        }
                    }
                });
            },
            
            /**
             * Hides/shows the Priorities nav link based on app mode.
             */
            updateNavVisibility() {
                const planningNavLinks = document.querySelectorAll('a[data-page="priorities"]');
                planningNavLinks.forEach(link => {
                    if (link.parentElement) {
                        link.parentElement.style.display = (state.appMode === 'planning') ? 'block' : 'none';
                    }
                });

                if (state.appMode === 'benchmark' && state.activePage === 'priorities') {
                    view.showPage('home');
                }
            },
            
            /**
             * Updates all progress bars and styling in the sidebar.
             * --- MODIFIED v1.6 ---
             * This now uses Domain.calculateScores() which correctly
             * accounts for practice.relevant.
             */
            updateSidebarProgress() {
                window.CMM_DATA.domains.forEach(domainData => {
                    const domain = state.assessmentData[domainData.id];
                    if (!domain) return;
                    
                    // This now returns completion % based on *relevant* practices
                    const { assessmentCompletion } = domain.calculateScores();
                    const percent = assessmentCompletion.toFixed(0);
                    
                    const label = document.querySelector(`[data-progress-label-domain="${domain.id}"]`);
                    const bar = document.querySelector(`[data-progress-bar-domain="${domain.id}"]`);
                    const navLink = document.querySelector(`a[data-domain="${domain.id}"]`);
                    
                    if (label) label.textContent = `${percent}%`;
                    if (bar) bar.style.width = `${percent}%`;
                    if (navLink) {
                        navLink.style.opacity = domain.relevant ? '1' : '0.5';
                        navLink.style.textDecoration = domain.relevant ? 'none' : 'line-through';
                    }
                });
            },

            /**
             * Updates the summary block on the assessment page.
             * --- MODIFIED v1.6 ---
             * This now uses Domain.calculateScores() which correctly
             * accounts for practice.relevant.
             */
            updateAssessmentSummary(domainId) {
                const domain = state.assessmentData[domainId];
                if (!domain) return;
                
                // These values are now based on *relevant* practices
                const { totalScore, totalMax, percent, assessmentCompletion } = domain.calculateScores();
                
                dom.assessmentSummary.innerHTML = `
                    <span class="font-bold">Domain Score:</span> ${totalScore} / ${totalMax}
                    <span class="font-bold ml-4">Score %:</span> ${percent.toFixed(1)}%
                `;

                let progressEl = document.getElementById('assessment-page-progress');
                const summaryParent = dom.assessmentSummary.parentElement;
                
                if (!progressEl && summaryParent) {
                    progressEl = document.createElement('div');
                    progressEl.id = 'assessment-page-progress';
                    progressEl.className = 'w-1/4';
                    summaryParent.insertBefore(progressEl, dom.assessmentSummary);
                }
                
                if (progressEl) {
                    const percent = assessmentCompletion.toFixed(0);
                    progressEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-slate-700">Assessment Progress</span>
                            <span class="text-sm font-medium text-slate-500">${percent}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    `;
                }
            },

            /**
             * Updates the subtotal for a single objective.
             * --- MODIFIED v1.6 ---
             * This now uses Objective.calculateScores() which correctly
             * accounts for practice.relevant.
             */
            updateObjectiveSubtotal(objective) {
                const subtotalEl = document.querySelector(`div[data-objective-id="${objective.name}"]`);
                if (!subtotalEl) return;
                
                // These values are now based on *relevant* practices
                const { 
                    totalScore: objTotalScore, 
                    totalMax: objTotalMax,
                    totalAssessed: objTotalAssessed,
                    totalPractices: objTotalPractices, // This is now count of *relevant* practices
                    percent: objPercent,
                    assessmentCompletion: objCompletion
                } = objective.calculateScores();
                
                subtotalEl.innerHTML = `
                    <span class="font-semibold">Section Subtotal:</span>
                    <span class="text-right">Completed: ${objTotalAssessed} / ${objTotalPractices} (${objCompletion.toFixed(1)}%)</span>
                    <span class="text-right">Score: ${objTotalScore} / ${objTotalMax} (${objPercent.toFixed(1)}%)</span>
                `;
            },
            
            /**
             * Updates the sort indicator icons on the priorities page.
             */
            updatePrioritySortHeaders() {
                const headers = document.querySelectorAll('#page-priorities .sortable-header');
                headers.forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (header.dataset.sort === state.prioritySort.column) {
                        header.classList.add(state.prioritySort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            },

            /**
             * Checks a practice's scores and applies/removes the warning state
             * from the target widget if the target is lower than the current score.
             */
            checkTargetScoreWarning(practice, targetWidgetElement) {
                const currentScore = utils.parseScore(practice.score);
                const targetScore = utils.parseScore(practice.targetScore);
                
                const widget = targetWidgetElement; 
                if (!widget) return; // Safety check

                const warningTitle = "Target level should be greater than or equal to the Current level.";
                const isWarning = (state.appMode === 'planning' && targetScore !== null && currentScore !== null && targetScore < currentScore);

                if (isWarning) {
                    widget.classList.add('widget-warning');
                    widget.setAttribute('title', warningTitle); // Set on parent
                    
                    // === NEW FIX ===
                    // Also set on all child dots, overriding their specific titles
                    widget.querySelectorAll('.target-dot').forEach(dot => {
                        dot.setAttribute('title', warningTitle);
                    });
                    // === END NEW FIX ===

                } else {
                    widget.classList.remove('widget-warning');
                    widget.removeAttribute('title'); // Remove from parent
                    
                    // === NEW FIX ===
                    // Restore original titles on child dots
                    widget.querySelectorAll('.target-dot').forEach(dot => {
                        const scoreValue = dot.dataset.score;
                        // Find the title from the SCORE_LEVELS constant
                        const level = SCORE_LEVELS.find(s => s.value == scoreValue);
                        const originalTitle = level ? level.title : '';
                        dot.setAttribute('title', `Target: ${originalTitle}`);
                    });
                    // === END NEW FIX ===
                }
            },

            /**
             * Gathers data, builds a CSV, and triggers a download.
             * --- MODIFIED v1.6 ---
             * Now filters out practices where practice.relevant is false.
             */
            exportPrioritiesToCSV() {
                console.log('Exporting priorities to CSV...');
                
                // 1. Get Data
                let priorityItems = [];
                for (const domainId in state.assessmentData) {
                    const domain = state.assessmentData[domainId];
                    if (domain.relevant === false) continue;
                    
                    domain.objectives.forEach(objective => {
                        objective.practices.forEach(practice => {
                            // === NEW v1.6: Skip irrelevant practices ===
                            if (!practice.relevant) return;

                            const currentScore = utils.parseScore(practice.score);
                            const targetScore = utils.parseScore(practice.targetScore);
                            
                            if (targetScore !== null && (currentScore === null || targetScore > currentScore)) {
                                priorityItems.push({
                                    domainNickname: domain.nickname,
                                    practice: practice
                                });
                            }
                        });
                    });
                }

                // 2. Sort Data (using the same logic as renderPrioritiesPage)
                priorityItems.sort((a, b) => {
                    const col = state.prioritySort.column;
                    const pA = a.practice;
                    const pB = b.practice;
                    let valA, valB;

                    switch (col) {
                        case 'priority':
                            valA = pA.calculatePriority();
                            valB = pB.calculatePriority();
                            if (valA === '-') valA = -Infinity;
                            if (valB === '-') valB = -Infinity;
                            break;
                        case 'impact': case 'loe':
                            valA = parseInt(pA[col], 10) || 0;
                            valB = parseInt(pB[col], 10) || 0;
                            break;
                        case 'score': case 'target':
                            const key = col === 'target' ? 'targetScore' : col;
                            valA = utils.parseScore(pA[key]);
                            valB = utils.parseScore(pB[key]);
                            if (valA === null) valA = -1;
                            if (valB === null) valB = -1;
                            break;
                        case 'date':
                            valA = pA.targetDate || '';
                            valB = pB.targetDate || '';
                            if (valA === '' && valB === '') return 0; // === FIX v1.6.1 ===
                            if (valA === '' && valB !== '') return 1;
                            if (valA !== '' && valB === '') return -1;
                            break;
                        case 'practice':
                            valA = (pA.slug || '').toLowerCase();
                            valB = (pB.slug || '').toLowerCase();
                            break;
                        case 'domain':
                        default:
                            valA = (a.domainNickname || '').toLowerCase();
                            valB = (b.domainNickname || '').toLowerCase();
                            break;
                    }
                    let result = (typeof valA === 'number' && typeof valB === 'number') ? (valA - valB) : String(valA).localeCompare(String(valB));
                    return state.prioritySort.direction === 'desc' ? result * -1 : result;
                });

                // 3. Build CSV String
                const headers = ['Domain', 'Practice', 'Score', 'Target', 'Impact', 'Effort', 'Priority', 'Target Date', 'Notes'];
                let csvContent = headers.join(',') + '\n';

                priorityItems.forEach(item => {
                    const practice = item.practice;
                    const priority = practice.calculatePriority();
                    const row = [
                        item.domainNickname,
                        practice.slug,
                        utils.parseScore(practice.score) === null ? '' : practice.score,
                        utils.parseScore(practice.targetScore) === null ? '' : practice.targetScore,
                        practice.impact || '',
                        practice.loe || '',
                        priority,
                        practice.targetDate || '',
                        practice.notes || ''
                    ];
                    // Use the secure escapeCSV function
                    csvContent += row.map(utils.escapeCSV).join(',') + '\n';
                });

                // 4. Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'cti-cmm-priorities.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Your browser does not support automatic CSV downloads.');
                }
            },

            /**
             * Gathers all user data, builds a JSON file, and triggers a download.
             * This now includes versioning information.
             */
            exportResultsToJSON() {
                console.log('Exporting results to JSON...');
                
                // 1. Get data (which now includes practice.relevant)
                const userData = store.getUserDataForSave();
                
                // NOTE: In a real app, you would pre-calculate this hash
                // when the cti-cmm-data.json file is built/deployed.
                const modelHash = "placeholder-sha256-of-cti-cmm-data.json";

                const exportData = {
                    assessmentName: state.assessmentName,
                    exportDate: new Date().toISOString(),
                    toolVersion: CURRENT_TOOL_VERSION,
                    modelHash: modelHash, 
                    data: userData
                };
                
                // 2. Build JSON String
                const jsonString = JSON.stringify(exportData, null, 2); // Pretty-print
                
                // 3. Create and trigger download
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    
                    // Create a sanitized filename
                    let fileName = (state.assessmentName || 'cti-cmm-assessment')
                        .trim()
                        .toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '')  // Remove non-alphanumeric/space/hyphen
                        .replace(/[\s_-]+/g, '-')     // Replace spaces/underscores with hyphens
                        .replace(/^-+|-+$/g, '');   // Trim leading/trailing hyphens
                    
                    if (fileName.length === 0) fileName = 'cti-cmm-assessment';

                    fileName = `${fileName}-export-${new Date().toISOString().split('T')[0]}.json`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Your browser does not support automatic JSON downloads.');
                }
            }
        };


        // --- 7. Event Handlers (events) ---
        // All functions that respond to user interactions
        const events = {
            /**
             * Handles clicks on the main navigation.
             */
            handleNavClick(e) {
                const target = e.target.closest('.nav-link');
                if (target) {
                    e.preventDefault(); 
                    const pageId = target.dataset.page;
                    const domainId = target.dataset.domain;
                    view.showPage(pageId, domainId, false); // Pass false, this is a user click
                }
            },

            /**
             * Handles the 'Planning Mode' toggle change.
             */
            handleModeToggle(e) {
                const newMode = e.target.checked ? 'planning' : 'benchmark';
                store.setAppMode(newMode);
                view.updateNavVisibility();
                // Re-render current page to show/hide fields
                view.showPage(state.activePage, state.activeDomain, false); // Pass false
            },
            
            /**
             * Main click handler for the content area (uses event delegation).
             */
            handleContentClick(e) {
                const target = e.target;
                
                // --- Widget Click ---
                const dot = target.closest('.maturity-dot, .target-dot');
                if (dot) {
                    events.handleWidgetClick(dot);
                    return;
                }
                
                // --- Collapse/Expand ---
                if (target.id === 'expand-all' || target.id === 'collapse-all') {
                    events.handleCollapseExpand(target.id);
                    return;
                }

                // --- Priority Sort ---
                const sortHeader = target.closest('.sortable-header');
                if (sortHeader) {
                    events.handlePrioritySortClick(sortHeader);
                    return;
                }

                // --- Export CSV ---
                if (target.id === 'export-csv') {
                    view.exportPrioritiesToCSV();
                    return;
                }
            },
            
            /**
             * Main change handler for the content area (uses event delegation).
             * --- MODIFIED v1.6 ---
             * Added logic to handle practice relevance toggle.
             */
            handleContentChange(e) {
                const target = e.target;
                const practiceId = target.dataset.id;
                const field = target.dataset.field;

                // --- Practice Field Change (inputs, textareas, selects) ---
                if (practiceId && field) {
                    let value = target.type === 'checkbox' ? target.checked : target.value;
                    const context = store.updatePracticeField(practiceId, field, value);
                    
                    if (context) {
                        // === NEW v1.6: Handle relevance toggle UI ===
                        if (field === 'relevant') {
                            const practiceRows = document.querySelectorAll(`[data-practice-row-id="${practiceId}"]`);
                            practiceRows.forEach(row => {
                                row.classList.toggle('content-disabled', !value);
                            });
                            
                            // === NEW MODIFICATION ===
                            // Find the practice info cell (slug/text)
                            const cellInfo = target.closest('td'); 
                            if (cellInfo) {
                                // Find the slug and text divs inside this cell
                                const slugDiv = cellInfo.querySelector('.font-semibold.text-slate-800');
                                const textDiv = cellInfo.querySelector('.text-slate-600.mt-1');
                                
                                if (slugDiv) {
                                    slugDiv.classList.toggle('line-through', !value);
                                    slugDiv.classList.toggle('text-slate-400', !value);
                                }
                                if (textDiv) {
                                    textDiv.classList.toggle('line-through', !value);
                                    textDiv.classList.toggle('text-slate-400', !value);
                                }
                            }
                            // === END NEW MODIFICATION ===
                            
                            // Recalculate sidebar
                            view.updateSidebarProgress();
                            
                            // If on dashboard or priorities, they need a full re-render
                            if (state.activePage === 'dashboard') {
                                view.renderDashboardPage();
                            }
                            if (state.activePage === 'priorities') {
                                view.renderPrioritiesPage();
                            }
                        }
                        // === END NEW v1.6 ===

                        // Update UI based on change
                        if (field === 'impact' || field === 'loe') {
                            const priorityDisplay = document.querySelector(`[data-priority-id="${context.practice.id}"]`);
                            if (priorityDisplay) {
                                // Use the class method to update
                                priorityDisplay.textContent = context.practice.calculatePriority();
                            }
                        }
                        // Recalculate and update summaries
                        if (context.domain) {
                            view.updateAssessmentSummary(context.domain.id);
                        }
                        if (context.objective) {
                            view.updateObjectiveSubtotal(context.objective);
                        }
                        // Refresh priorities if a planning field changed
                        if (state.activePage === 'priorities' && ['targetScore', 'impact', 'loe', 'targetDate'].includes(field)) {
                            view.renderPrioritiesPage();
                        }
                        // Refresh dashboard if a score changed
                        if (state.activePage === 'dashboard' && (field === 'score' || field === 'targetScore')) {
                            view.renderDashboardPage();
                        }
                    }
                    return;
                }

                // --- Domain Field Change (date, relevant) ---
                if (target.id === 'assessment-date') {
                    store.updateDomainMeta(state.activeDomain, 'date', target.value);
                    return;
                }
                if (target.id === 'assessment-relevant') {
                    const isRelevant = target.checked;
                    store.updateDomainMeta(state.activeDomain, 'relevant', isRelevant);
                    
                    // Update UI
                    view.updateSidebarProgress();
                    if (state.activePage === 'dashboard') view.renderDashboardPage();
                    if (state.activePage === 'priorities') view.renderPrioritiesPage();
                    
                    // Toggle disabled overlay on current page
                    if (isRelevant) {
                        dom.assessmentObjectivesContainer.classList.remove('content-disabled');
                        dom.assessmentDisabledBanner.classList.add('hidden');
                    } else {
                        dom.assessmentObjectivesContainer.classList.add('content-disabled');
                        dom.assessmentDisabledBanner.classList.remove('hidden');
                    }
                    return;
                }
            },

            // --- Sub-handlers (called by main handlers) ---
            
            handleWidgetClick(dot) {
                const widget = dot.closest('.maturity-widget, .target-widget');
                if (!widget) return;

                const practiceId = widget.dataset.id;
                const newScore = parseInt(dot.dataset.score, 10);
                const field = dot.dataset.field;
                if (!field) return;

                const { practice } = store.getPracticeInstanceById(practiceId);
                if (!practice) return;

                // Toggle null/value
                const finalScore = (utils.parseScore(practice[field]) === newScore) ? null : newScore;
                
                const context = store.updatePracticeField(practiceId, field, finalScore);
                
                if (context) {
                    // Update UI
                    view.updateDotWidget(widget, finalScore);
                    
                    // === MODIFIED LOGIC ===
                    // Find the practice's target widget (even if we clicked the current widget)
                    const practiceRow = widget.closest('tbody');
                    if (practiceRow) {
                        const targetWidget = practiceRow.querySelector(`.target-widget[data-id="${practiceId}"]`);
                        if (targetWidget) {
                            view.checkTargetScoreWarning(context.practice, targetWidget);
                        }
                    }
                    // === END MODIFIED LOGIC ===

                    if (context.domain) {
                        view.updateAssessmentSummary(context.domain.id);
                    }
                    if (context.objective) {
                        view.updateObjectiveSubtotal(context.objective);
                    }
                    if (field === 'score') {
                        view.updateSidebarProgress();
                        if (state.activePage === 'dashboard') view.renderDashboardPage();
                    }
                    if (field === 'targetScore') {
                        if (state.activePage === 'dashboard') view.renderDashboardPage();
                        if (state.activePage === 'priorities') view.renderPrioritiesPage();
                    }
                }
            },

            handleCollapseExpand(actionId) {
                const detailsElements = document.querySelectorAll('#page-assessment details');
                detailsElements.forEach(details => {
                    details.open = (actionId === 'expand-all');
                });
            },



            handlePrioritySortClick(header) {
                const newColumn = header.dataset.sort;
                if (!newColumn) return;

                let newDirection = 'asc';
                if (state.prioritySort.column === newColumn) {
                    newDirection = (state.prioritySort.direction === 'asc') ? 'desc' : 'asc';
                } else {
                    const descDefaults = ['priority', 'impact', 'score', 'target'];
                    newDirection = descDefaults.includes(newColumn) ? 'desc' : 'desc';
                }
                
                store.setPrioritySort(newColumn, newDirection);
                view.renderPrioritiesPage(); // Re-render will read new state
            },

            /**
             * Handles the browser's back/forward button navigation.
             */
            handlePopState(e) {
                if (e.state) {
                    // e.state is the { page, domain } object we pushed
                    console.log('PopState: Navigating to', e.state);
                    view.showPage(e.state.page, e.state.domain, true); // Pass true
                } else {
                    // This happens when going back to the very first load
                    console.log('PopState: Navigating to initial state (home)');
                    view.showPage('home', null, true); // Pass true
                }
            },

            /**
             * Handles the assessment name input change.
             */
            handleAssessmentNameChange(e) {
                state.assessmentName = e.target.value;
                store.saveAssessmentName();
            },

            /**
             * Handles the file import selection, now with version checking.
             */
            handleImportChange(e) {
                const file = e.target.files[0];
                if (!file) {
                    return; // No file selected
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        // --- SECURE MODIFICATION: Use a reviver to block __proto__ ---
                        const importedData = JSON.parse(event.target.result, (key, value) => {
                            if (key === '__proto__') {
                                return undefined; // Disallow __proto__
                            }
                            return value;
                        });
                        // --- END MODIFICATION ---
                        
                        // Basic validation
                        if (typeof importedData !== 'object' || importedData === null || !importedData.data || !importedData.hasOwnProperty('assessmentName')) {
                            throw new Error('Invalid file structure. Missing "data" or "assessmentName" key.');
                        }

                        // --- VERSION CHECKING ---
                        const importedVersion = importedData.toolVersion;
                        if (!importedVersion) {
                            // Legacy format (pre-1.3)
                            if (!confirm('This appears to be an older export file. Importing it may result in data loss for any new fields (like practice relevance). Continue?')) {
                                e.target.value = null; // Reset file input
                                return;
                            }
                        } else if (parseFloat(importedVersion) > parseFloat(CURRENT_TOOL_VERSION)) {
                            // Newer format
                            alert(`Warning: This file was exported from a newer tool version (${importedVersion}). Your current version is ${CURRENT_TOOL_VERSION}. Importing may cause errors or data loss.`);
                        } else if (parseFloat(importedVersion) < parseFloat(CURRENT_TOOL_VERSION)) {
                            // Older, but versioned format
                            console.log(`Importing data from older version ${importedVersion}. Migration logic would run here if needed.`);
                            // e.g., if v1.5 imported, the new `relevant` field will just get the default `true`
                        }
                        // --- END VERSION CHECKING ---

                        
                        if (confirm('This will overwrite all current assessment data in your browser. This action cannot be undone. Are you sure you want to proceed?')) {
                            // Save the new data
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData.data));
                            localStorage.setItem(ASSESSMENT_NAME_KEY, importedData.assessmentName);
                            
                            // Reload to apply
                            alert('Import successful! The application will now reload.');
                            location.reload();
                        } else {
                            // User cancelled
                            e.target.value = null; // Reset file input
                        }
                    } catch (error) {
                        console.error('Import failed:', error);
                        alert('Import failed. The selected file is either not valid JSON or does not have the correct CTI-CMM export format.');
                        e.target.value = null; // Reset file input
                    }
                };
                reader.readAsText(file);
            }
        };


        // --- 8. Initialization ---
        
        /**
         * Attaches all permanent event listeners.
         */
        function bindEvents() {
            dom.mainNav.addEventListener('click', events.handleNavClick);
            dom.resetData.addEventListener('click', store.resetData);
            dom.modeToggle.addEventListener('change', events.handleModeToggle);
            
            // --- Event Delegation ---
            dom.mainContent.addEventListener('change', events.handleContentChange);
            dom.mainContent.addEventListener('click', events.handleContentClick);

            // --- Sidebar Listeners ---
            dom.assessmentNameInput.addEventListener('change', events.handleAssessmentNameChange);
            dom.exportButton.addEventListener('click', view.exportResultsToJSON);
            dom.importButton.addEventListener('change', events.handleImportChange);

            // --- Handle Browser Back/Forward ---
            window.addEventListener('popstate', events.handlePopState);
        }

        /**
         * Public init function to start the application.
         * This is called by the data loader IIFE.
         */
        function init() {
            console.log(`CTI-CMM Tool Initializing (v${CURRENT_TOOL_VERSION})...`);
            if (!window.CMM_DATA) {
                console.error("CMM_DATA not found. Initialization failed.");
                return;
            }
            
            store.loadState(); // Load mode and data from localStorage into class instances

            // Populate Domain Nav
            window.CMM_DATA.domains.forEach(domain => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700 text-sm" data-page="assessment" data-domain="${domain.id}">
                        <div class="flex justify-between items-center">
                            <span>${domain.nickname}</span>
                            <span class="text-xs text-slate-400" data-progress-label-domain="${domain.id}">0%</span>
                        </div>
                        <div class="w-full bg-slate-600 rounded-full h-1 mt-1">
                            <div data-progress-bar-domain="${domain.id}" class="bg-blue-500 h-1 rounded-full" style="width: 0%"></div>
                        </div>
                    </a>`;
                dom.domainNav.appendChild(li);
            });

            bindEvents();
            
            // === MODIFICATION FOR URL PARAMS & VIEW RESTORE ===
            
            // 1. Check URL parameters first (explicit intent)
            let urlPage = utils.getUrlParameter('page');
            let urlDomain = utils.getUrlParameter('domain');

            // Handle shortcut: ?domain=ASSET should imply page=assessment
            if (urlDomain && !urlPage) {
                urlPage = 'assessment';
            }

            let lastPage = 'home';
            let lastDomain = null;

            if (urlPage) {
                // Use URL params
                lastPage = urlPage;
                lastDomain = urlDomain;
                console.log(`Loading from URL: ${lastPage}, ${lastDomain || ''}`);
            } else {
                // 2. If no URL params, check localStorage (previous session)
                try {
                    const savedView = localStorage.getItem(VIEW_STORAGE_KEY);
                    if (savedView) {
                        const parsedView = JSON.parse(savedView);
                        lastPage = parsedView.page || 'home';
                        lastDomain = parsedView.domain || null;
                        console.log(`Restoring from localStorage: ${lastPage}, ${lastDomain || ''}`);
                    }
                } catch (e) {
                    console.warn('localStorage read failed (view):', e.message);
                }
            }
            
            // 3. Set the initial page. showPage() will save this as the new "last view"
            view.showPage(lastPage, lastDomain, false); 
            
            // 4. Run visibility checks
            view.updateNavVisibility(); 
            view.updateSidebarProgress(); 
            
            // === END MODIFICATION ===
            
            console.log('...Initialization Complete.');
        }

        // --- 9. Public API ---
        // Expose only the init function to the outside world
        return {
            init: init
        };

    })();
    </script>
    </body>
</html>