<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTI-CMM Assessment Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Load the CMM data from the JSON file before the main script runs
        (async () => {
            try {
                const response = await fetch('cti-cmm-data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                window.CMM_DATA = await response.json();
                console.log('CMM data loaded from JSON.');
                initializeApp(); // Initialize the app after data is loaded
            } catch (e) {
                console.error("Failed to load cti-cmm-data.json:", e);
                // Display an error to the user on the page
                document.body.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Fatal Error:</strong>
                    <span class="block sm:inline">Could not load assessment data file (cti-cmm-data.json). Please ensure the file is present and accessible.</span>
                </div>`;
            }
        })();
    </script>
    <style>
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #64748b; /* slate-500 */
        }
        ::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Ensure inputs in tables don't mess up cell height */
        td input, td select, td textarea {
            font-size: 0.875rem; /* text-sm */
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            max-width: 100%;
            box-sizing: border-box;
        }
        /* Style for the active nav link */
        .nav-link.active {
            background-color: #334155; /* slate-700 */
            font-weight: 600;
        }
        /* Custom class for small table cells */
        .cell-sm {
            width: 5rem; /* 80px */
        }
        .cell-md {
            width: 10rem; /* 160px */
        }
        .cell-lg {
            width: 20rem; /* 320px */
        }
        /* Hide pages by default */
        .page {
            display: none;
        }
        
        /* New styles for the assessment page tables */
        .assessment-table th, .assessment-table td {
            font-size: 0.875rem; /* text-sm */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            vertical-align: top;
            border-bottom-width: 1px;
            border-color: #e5e7eb; /* slate-200 */
        }
        
        /* Header style (still used by Dashboard/Priorities) */
        .assessment-table th {
            background-color: #f8fafc; /* slate-50 */
            text-align: left;
            font-weight: 500; /* medium */
            color: #475569; /* slate-600 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem; /* text-xs */
        }
        
        /* Widget Label Style */
        .widget-label {
            font-size: 0.65rem; /* 10px */
            font-weight: 500; /* medium */
            color: #475569; /* slate-600 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-bottom: 0.25rem; /* pb-1 */
            padding-left: 0.25rem; /* pl-1 */
        }

        /* --- Maturity Widgets Base --- */
        .maturity-widget, .target-widget {
            display: flex;
            align-items: flex-start; /* Aligns dots and lines */
            padding-left: 2px; /* Small offset */
        }
        .maturity-widget {
             padding-top: 4px; /* Align with other inputs */
        }
        .target-widget {
             padding-top: 4px;
        }
        .maturity-line, .target-line {
            width: 40px; /* Fixed width for compactness */
            height: 2px;
            background-color: #cbd5e1; /* slate-300 */
            transition: background-color 0.2s ease;
            margin-top: 8px; /* Aligns line with center of 18px dot */
        }
        .maturity-label {
            font-size: 0.75rem; /* text-xs */
            color: #64748b; /* slate-500 */
            margin-top: 0.25rem; /* mt-1 */
            width: 18px; /* Match the dot width */
            text-align: center; /* Center the number */
        }

        /* --- CURRENT (Blue) Widget --- */
        .maturity-dot {
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1; /* slate-300 */
            border-radius: 50%;
            cursor: pointer;
            background-color: #fff;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        .maturity-dot:hover { border-color: #3b82f6; /* blue-500 */ }
        .maturity-dot.active { background-color: #3b82f6; border-color: #3b82f6; }
        .maturity-dot.selected {
            border-color: #1d4ed8; /* blue-700 */
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .maturity-line.active { background-color: #3b82f6; }

        /* --- TARGET (Green) Widget --- */
        .target-dot {
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1; /* slate-300 */
            border-radius: 50%;
            cursor: pointer;
            background-color: #fff;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        .target-dot:hover { border-color: #22c55e; /* green-500 */ }
        .target-dot.active { background-color: #22c55e; border-color: #22c55e; }
        .target-dot.selected {
            border-color: #15803d; /* green-700 */
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        }
        .target-line.active { background-color: #22c55e; }

        /* --- Sortable Header --- */
        .sortable-header {
            cursor: pointer;
            user-select: none; /* Prevent text selection on click */
            position: relative; /* For icon positioning */
        }
        .sortable-header:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .sortable-header span {
            display: inline-block;
            width: 1em; /* Reserve space */
            text-align: right;
            color: #94a3b8; /* slate-400 */
        }
        .sortable-header.sort-asc span::after {
            content: '▲';
            color: #334155; /* slate-700 */
        }
        .sortable-header.sort-desc span::after {
            content: '▼';
            color: #334155; /* slate-700 */
        }
        .sortable-header:not(.sort-asc):not(.sort-desc) span::after {
            content: '↕'; /* Default icon */
        }

    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900">

    <div class="flex h-screen overflow-hidden">
        <nav class="w-64 bg-slate-800 text-slate-200 flex-shrink-0 overflow-y-auto">
            <div class="p-4">
                <h1 class="text-xl font-bold text-white">CTI-CMM Tool</h1>
                <span class="text-sm text-slate-400">Assessment v1.2</span>
            </div>
            <ul id="main-nav" class="space-y-1 p-2">
                <li><a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700" data-page="home">Home</a></li>
                <li><a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700" data-page="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700" data-page="priorities">Priorities Sheet</a></li>
                
                <li class="pt-4">
                    <h2 class="px-3 text-sm font-semibold text-slate-400 uppercase tracking-wider">Assessment Domains</h2>
                    <ul id="domain-nav" class="mt-1 space-y-1">
                        </ul>
                </li>

                <li class="pt-8">
                    <h2 class="px-3 text-sm font-semibold text-slate-400 uppercase tracking-wider">Settings</h2>
                    <div class="p-3 text-sm">
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-slate-200">Planning Mode</span>
                            <div class="relative">
                                <input type="checkbox" id="mode-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-600 rounded-full peer-checked:bg-blue-600"></div>
                                <div class="absolute top-0.5 left-[2px] bg-white w-5 h-5 rounded-full transition-all peer-checked:translate-x-full"></div>
                            </div>
                        </label>
                        <p class="mt-2 text-xs text-slate-500">
                            Enable to show Target, Priority, and planning fields.
                        </p>
                    </div>
                </li>
                <li class="pt-8">
                    <h2 class="px-3 text-sm font-semibold text-slate-400 uppercase tracking-wider">Data</h2>
                    <div class="p-2">
                        <button id="reset-data" class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded-md">
                            Reset All Data
                        </button>
                        <p class="mt-2 text-xs text-slate-500">
                            Scores are locally saved in your browser. This button clears all your saved scores. This cannot be undone.
                        </p>
                    </div>
                </li>
            </ul>
        </nav>

        <main id="main-content" class="flex-1 overflow-y-auto p-6 md:p-8">
            
            <div id="page-home" class="page max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-slate-800 mb-4">Welcome to the CTI-CMM Assessment Tool (BETA Version 1.2)</h2>
                    <p class="text-lg text-slate-600 mb-6">The Cyber Threat Intelligence Capability Maturity Model (CTI-CMM) is designed to help improve cyber threat intelligence teams support to cybersecurity and risk management functions, leading to improved security outomes. Its goal is to provide a roadmap on how intelligence programs can mature existing support and process constructs to ultimately strengthen the organization's operational resilience. The CTI-CMM is industry sector, organization type, and size agnostic and was inspired by the U.S. Department of Energy's C2M2 cybersecurity framework. </p>

                    <p class="text-lg text-slate-600 mb-6">The CTI-CMM offers a stakeholder-first approach to CTI maturity. The CTI-CMM focuses on the implementation and management of CTI best practices associated with information technology (IT), operational technology (OT), and information assets and the environments in which they operate. The model can be used to:</p>
        
        <div class="text-lg text-slate-600 mb-6">
            <ul class="list-disc pl-5 space-y-1">
                <li>Enable organizations to effectively and consistently evaluate and benchmark cyber threat intelligence capabilities</li>
                <li>Improve organizational reach and support to cybersecurity and risk management stakeholders</li>
                <li>Establish a roadmap to grow CTI program capabilities and improve existing maturity</li>
                <li>Prioritize investment and actions to improve cyber threat intelligence capabilities</li>
                <li>Share knowledge and best practices on CTI program operations</li>
            </ul>
        </div>
                    <p class="text-lg text-slate-600 mb-6"></p>

                    <div class="prose max-w-none prose-slate">
                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">How to Use This Tool</h3>
                        <p class="text-lg text-slate-600 mb-6">This tool is a stand-alone web application to help you self-evaluate your current maturity posture across each of the CTI-CMM domains.</p>
                        <ol class="list-decimal list-inside space-y-2">
                            <li  class="text-lg text-slate-600 mb-6"><strong>Navigate Domains:</strong> Use the sidebar to select one of the 11 CTI-CMM domains.</li>
                            <li  class="text-lg text-slate-600 mb-6"><strong>Choose Your Mode:</strong> Use the "Planning Mode" toggle in the sidebar.
                                <ul class="list-disc list-inside">
                                    <li><strong>Benchmark Mode (Off):</strong> Assess your `Current` maturity and add `Evidence`, `Point of Contact`, and `Notes`.</li>
                                    <li><strong>Planning Mode (On):</strong> Adds fields for `Target` maturity, `Target Date`, `Impact`, `Effort`, and `Priority`.</li>
                                </ul>
                            </li>
                            <li class="text-lg text-slate-600 mb-6"><strong>Self-Assess:</strong> For each practice, select your <strong>Current</strong> and <strong>Target</strong> Maturity (0-3) using the clickable dot widgets. Your progress is tracked by the progress bars in the sidebar.</li>
                            <li class="text-lg text-slate-600 mb-6"><strong>Auto-Save:</strong> All your entries are saved to your browser's local storage automatically. You can leave and come back at any time.</li>
                            <li class="text-lg text-slate-600 mb-6"><strong>View Results:</strong>
                                <ul class="list-disc list-inside">
                                    <li>The <strong>Dashboard</strong> shows your overall maturity and completion percentage for each domain.</li>
                                    <li>The <strong>Priorities Sheet</strong> (available in Planning Mode) aggregates all your assessment items and helps you plan your improvement journey.</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <h3 class="text-xl font-semibold text-slate-800 mt-6 mb-2">The 11 CTI-CMM Domains</h3>
                        <p class="text-lg text-slate-600 mb-6">The CTI-CMM v1.2 is organized into 11 domains, comprised of two or more objectives:</p>
                        <ul class="list-decimal list-inside text-lg text-slate-600 mb-6">
                            <li>Asset, Change, and Configuration Management (ASSET)</li>
                            <li>Threat and Vulnerability Management (THREAT)</li>
                            <li>Risk Management (RISK)</li>
                            <li>Identity and Access Management (ACCESS)</li>
                            <li>Situational Awareness (SITUATION)</li>
                            <li>Event and Incident Response, Continuity of Operations (RESPONSE)</li>
                            <li>Third-Party Risk Management (THIRD-PARTIES)</li>
                            <li>Fraud and Abuse Management (FRAUD)</li>
                            <li>Workforce Management (WORKFORCE)</li>
                            <li>Cybersecurity Architecture (ARCHITECTURE)</li>
                            <li>Cybersecurity Program Management (PROGRAM)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="page-dashboard" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Assessment Dashboard</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Domain Maturity Overview</h3>
                        <div class="relative h-96 w-full">
                            <canvas id="maturityRadarChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Overall Progress</h3>
                        <div class="relative h-96 w-full flex items-center justify-center">
                            <canvas id="overallProgressDoughnut"></canvas>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-white rounded-lg shadow-md overflow-hidden">
                    <h3 class="text-xl font-semibold p-6">Domain Subtotals</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Domain</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Score</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Max Score</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">% Complete</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Target %</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-slate-200">
                                </tbody>
                            <tfoot class="bg-slate-50">
                                <tr id="dashboard-table-footer" class="font-bold">
                                    </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-assessment" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="assessment-title" class="text-3xl font-bold text-slate-800"></h2>
                    <div class="flex space-x-2">
                        <button id="expand-all" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md text-sm font-medium">Expand All</button>
                        <button id="collapse-all" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md text-sm font-medium">Collapse All</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
                    <div>
                        <span class="font-bold">Date Last Assessed:</span>
                        <input type="date" id="assessment-date" class="ml-2 p-1 border rounded-md">
                    </div>
                    <div>
                        <label for="assessment-relevant" class="font-bold">Domain is Relevant?</label>
                        <input type="checkbox" id="assessment-relevant" class="ml-2 h-5 w-5 text-blue-600 rounded">
                    </div>
                    <div id="assessment-summary" class="text-right">
                        </div>
                </div>
                
                <div id="assessment-objectives-container" class="space-y-6">
                    </div>
            </div>

            <div id="page-priorities" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Priorities Planning Sheet</h2>

                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">What is this?</h3>
                    <p class="text-slate-600">This planning sheet aggregates all practices where your <strong>Target Score</strong> is greater than your current <strong>Score</strong> (or where your Current Score is not yet set). Click any column header to sort the list and help you plan your improvement journey.</p>
                    <div class="mt-4">
                        <button id="export-csv" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                            Export to CSV
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="domain">Domain <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="practice">Practice <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="score">Score <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="target">Target <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="impact">Impact <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="loe">Effort <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="priority">Priority <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="date">Target Date <span></span></th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable-header" data-sort="notes">Notes <span></span></th>
                                </tr>
                            </thead>
                            <tbody id="priorities-table-body" class="bg-white divide-y divide-slate-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- DATA MODEL ---
        // All data is now loaded from cti-cmm-data.js
        // CMM_DATA.domains contains the domain list
        // CMM_DATA.objectives contains the objectives and practices

        // This object holds all the objectives and practices for each domain.
        // It's also the structure that will be saved to localStorage.
        let assessmentData = {};
        let appMode = 'benchmark'; // 'benchmark' or 'planning'
        let prioritySort = { column: 'priority', direction: 'desc' }; // State for priority sorting

        // Helper to patch domain names (from request 3)
        // This patches the "name": "nan" bug from the source data
        const DOMAIN_NAME_MAP = {
            "ASSET": "Asset, Change, and Configuration Management",
            "THREAT": "Threat and Vulnerability Management",
            "RISK": "Risk Management",
            "ACCESS": "Identity and Access Management",
            "SITUATION": "Situational Awareness",
            "RESPONSE": "Event and Incident Response, Continuity of Operations",
            "THIRD-PARTIES": "Third-Party Risk Management",
            "FRAUD": "Fraud and Abuse Management",
            "WORKFORCE": "Workforce Management",
            "ARCHITECTURE": "Cybersecurity Architecture",
            "PROGRAM": "Cybersecurity Program Management"
        };

        // =================================================================
        // === FIX_HERE: Corrected function to parse new CMM_DATA structure ===
        // =================================================================
        // This function builds the initial state from cti-cmm-data.js
        function getDefaultAssessmentData() {
            const defaultData = {};
            
            // Use CMM_DATA.domains to iterate
            CMM_DATA.domains.forEach(domain => {
                const domainId = domain.id;
                // Get the objectives for this domain (e.g., CMM_DATA.objectives['ASSET'])
                const objectivesFromData = CMM_DATA.objectives[domainId];
                
                const newObjectivesArray = [];
                if (objectivesFromData) {
                    
                    // CMM_DATA.objectives[domainId] is an *object* where keys are the
                    // prefixed names (e.g., "1. IMPROVE...").
                    // We need to get the keys and sort them to ensure "1." comes before "2."
                    const objectiveKeys = Object.keys(objectivesFromData).sort();

                    // Now loop through the *sorted keys*
                    for (const objectiveKey of objectiveKeys) {
                        // Get the actual objective data object
                        // This is the object { id, name, practices } from the Python script
                        const objectiveData = objectivesFromData[objectiveKey];
                        
                        // ==================================
                        // === START MODIFICATION: Set default scores to null ===
                        // ==================================
                        // Deep copy practices and set default scores to null
                        const defaultPractices = JSON.parse(JSON.stringify(objectiveData.practices)).map(p => ({
                            ...p,
                            score: null, // Default to null (unset)
                            targetScore: null, // Default to null (unset)
                        }));
                        // ==================================
                        // === END MODIFICATION ===
                        // ==================================

                        // Add this object to our array
                        newObjectivesArray.push({
                            id: objectiveData.id,        // e.g., "ASSET-1"
                            name: objectiveData.name,      // e.g., "IMPROVE ASSET VISIBILITY"
                            // Deep copy practices array to avoid mutation of original data
                            // practices: JSON.parse(JSON.stringify(objectiveData.practices)) // OLD
                            practices: defaultPractices // NEW
                        });
                    }
                }

                defaultData[domainId] = {
                    date: '',
                    relevant: true,
                    objectives: newObjectivesArray // This is now a correctly structured array
                };
            });
            
            try {
                // This function is now the source of truth
                return defaultData;
            } catch (e) {
                console.error("Failed to build default data:", e);
                return {}; // Return empty object as a fallback
            }
        }
        // =================================================================
        // === END OF FIX ===
        // =================================================================


        // --- STATE MANAGEMENT ---
        const STORAGE_KEY = 'ctiCmmAssessmentData';
        const MODE_STORAGE_KEY = 'ctiCmmAppMode';

        function saveState() {
            try {
                const dataToSave = JSON.stringify(assessmentData);
                localStorage.setItem(STORAGE_KEY, dataToSave);
                console.log('Assessment data saved.');
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
                // Handle potential full storage
            }
        }

        function saveMode() {
            try {
                localStorage.setItem(MODE_STORAGE_KEY, appMode);
                console.log('App mode saved.');
            } catch (e) {
                console.warn('localStorage write failed (mode):', e.message);
                // If saving fails, we just warn the user in the console
                // The app will continue to work, but the mode won't save
            }
        }

        function loadState() {
            // Load app mode
            try {
                appMode = localStorage.getItem(MODE_STORAGE_KEY) || 'benchmark';
            } catch (e) {
                console.warn('localStorage read failed (mode):', e.message);
                appMode = 'benchmark'; // Default to benchmark if storage fails
            }
            document.getElementById('mode-toggle').checked = (appMode === 'planning');
            
            // Load assessment data
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                const defaultData = getDefaultAssessmentData();
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Merge saved data with default structure to ensure new practices are added
                    // and null defaults are respected
                    assessmentData = deepMerge(defaultData, parsedData);
                    console.log('Assessment data loaded.');
                } else {
                    assessmentData = defaultData;
                    console.log('No saved data. Initializing default data.');
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                assessmentData = getDefaultAssessmentData();
            }
        }
        
        // Simple deep merge helper
        function deepMerge(target, source) {
            const isObject = (obj) => obj && typeof obj === 'object' && !Array.isArray(obj);
            let output = Object.assign({}, target);
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key]) && !Array.isArray(source[key])) { // Don't merge arrays, replace them
                        if (!(key in target))
                            Object.assign(output, { [key]: source[key] });
                        else
                            output[key] = deepMerge(target[key], source[key]);
                    } else {
                        Object.assign(output, { [key]: source[key] });
                    }
                });
            }
            return output;
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all assessment data? This action cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- UTILITY FUNCTIONS ---

        // ==================================
        // === START MODIFICATION: New score parser ===
        // ==================================
        /**
         * Parses a score from the data model.
         * Returns null if unset (null, undefined), otherwise returns the integer value.
         */
        function parseScore(score) {
            if (score === null || score === undefined) {
                return null;
            }
            const intScore = parseInt(score, 10);
            return isNaN(intScore) ? null : intScore;
        }
        // ==================================
        // === END MODIFICATION ===
        // ==================================

        function getPracticeById(practiceId) {
            // This function relies on the `assessmentData` structure created
            // by the (now fixed) getDefaultAssessmentData
            for (const domainKey in assessmentData) {
                const domain = assessmentData[domainKey];
                if (domain.objectives) {
                    for (const objective of domain.objectives) {
                        const practice = objective.practices.find(p => p.id === practiceId);
                        if (practice) {
                            return { practice, domainId: domainKey, objective };
                        }
                    }
                }
            }
            return { practice: null, domainId: null, objective: null };
        }

        function getStatusFromScore(score) {
            // ==================================
            // === START MODIFICATION: Handle null score ===
            // ==================================
            score = parseScore(score);
            if (score === null) return "Not Assessed";
            // ==================================
            // === END MODIFICATION ===
            // ==================================

            switch (score) {
                case 0: return "Not Implemented";
                case 1: return "Partially Implemented";
                case 2: return "Largely Implemented";
                case 3: return "Fully Implemented";
                default: return "Not Assessed";
            }
        }

        function calculatePriority(impact, loe) {
            const impactVal = parseInt(impact, 10);
            const loeVal = parseInt(loe, 10);

            // Our dropdowns default to 1
            if (!impactVal || !loeVal || impactVal < 1 || loeVal < 1) {
                return "-"; // Use a dash for unset
            }
            
            // Formula: Impact + (4 - LOE)
            return impactVal + (4 - loeVal);
        }
        
        // Helper function: Update objective subtotal
        function updateObjectiveSubtotal(objective) {
            // Find the subtotal element by its data attribute
            // (objective.name is now the *clean* name, e.g. "IMPROVE ASSET VISIBILITY")
            const subtotalEl = document.querySelector(`div[data-objective-id="${objective.name}"]`);
            if (!subtotalEl) return;

            // ==================================
            // === START MODIFICATION: Update subtotal logic ===
            // ==================================
            let objTotalScore = 0;
            let objTotalMax = 0;
            let objTotalAssessed = 0;
            let objTotalPractices = 0;
            
            objective.practices.forEach(practice => {
                objTotalPractices++;
                const currentScore = parseScore(practice.score);

                if (currentScore !== null) {
                    objTotalAssessed++;
                    objTotalScore += currentScore;
                }
                objTotalMax += parseInt(practice.max, 10) || 0;
            });
            
            const objPercent = objTotalMax > 0 ? (objTotalScore / objTotalMax) * 100 : 0;
            const objCompletion = objTotalPractices > 0 ? (objTotalAssessed / objTotalPractices) * 100 : 0;
            
            subtotalEl.innerHTML = `
                <span class="font-semibold">Section Subtotal:</span>
                <span class="text-right">Completed: ${objTotalAssessed} / ${objTotalPractices} (${objCompletion.toFixed(1)}%)</span>
                <span class="text-right">Score: ${objTotalScore} / ${objTotalMax} (${objPercent.toFixed(1)}%)</span>
            `;
            // ==================================
            // === END MODIFICATION ===
            // ==================================
        }

        function calculateDomainScores(domainId) {
            const domain = assessmentData[domainId];
            // ==================================
            // === START MODIFICATION: Update scoring logic ===
            // ==================================
            let totalScore = 0;
            let totalMax = 0;
            let totalTargetScore = 0;
            let totalAssessed = 0;
            let totalPractices = 0;
            
            if (domain && domain.objectives) {
                for (const objective of domain.objectives) {
                    for (const practice of objective.practices) {
                        totalPractices++;
                        const currentScore = parseScore(practice.score);
                        const targetScore = parseScore(practice.targetScore);

                        if (currentScore !== null) {
                            totalAssessed++;
                            totalScore += currentScore;
                        }
                        if (targetScore !== null) {
                            totalTargetScore += targetScore;
                        }
                        
                        totalMax += parseInt(practice.max, 10) || 0;
                    }
                }
            }
            
            const percent = totalMax > 0 ? (totalScore / totalMax) * 100 : 0;
            const targetPercent = totalMax > 0 ? (totalTargetScore / totalMax) * 100 : 0;
            const assessmentCompletion = totalPractices > 0 ? (totalAssessed / totalPractices) * 100 : 0;
            
            return { totalScore, totalMax, percent, totalTargetScore, targetPercent, assessmentCompletion, totalAssessed, totalPractices };
            // ==================================
            // === END MODIFICATION ===
            // ==================================
        }

        function calculateAllScores() {
            // ==================================
            // === START MODIFICATION: Update scoring logic ===
            // ==================================
            let grandTotalScore = 0;
            let grandTotalMax = 0;
            let grandTotalTargetScore = 0;
            let grandTotalAssessed = 0;
            let grandTotalPractices = 0;

            const domainScores = CMM_DATA.domains.map(domain => {
                const scores = calculateDomainScores(domain.id);
                grandTotalScore += scores.totalScore;
                grandTotalMax += scores.totalMax;
                grandTotalTargetScore += scores.totalTargetScore;
                grandTotalAssessed += scores.totalAssessed;
                grandTotalPractices += scores.totalPractices;
                return { ...domain, ...scores };
            });

            const overallPercent = grandTotalMax > 0 ? (grandTotalScore / grandTotalMax) * 100 : 0;
            const overallTargetPercent = grandTotalMax > 0 ? (grandTotalTargetScore / grandTotalMax) * 100 : 0;
            const overallAssessmentCompletion = grandTotalPractices > 0 ? (grandTotalAssessed / grandTotalPractices) * 100 : 0;

            return { 
                domainScores, 
                grandTotalScore, 
                grandTotalMax, 
                grandTotalTargetScore, 
                overallPercent, 
                overallTargetPercent,
                overallAssessmentCompletion,
                grandTotalAssessed,
                grandTotalPractices
            };
            // ==================================
            // === END MODIFICATION ===
            // ==================================
        }

        // --- PAGE RENDERING ---

        let activePage = 'home';
        let activeDomain = null;
        let chartInstances = {
            radar: null,
            doughnut: null
        };

        function showPage(pageId, domainId = null) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            // Show the target page
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.style.display = 'block';
            }

            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId && (!domainId || link.dataset.domain === domainId)) {
                    link.classList.add('active');
                }
            });

            activePage = pageId;
            activeDomain = domainId;

            // Call render functions
            switch (pageId) {
                case 'home':
                    renderHomePage();
                    break;
                case 'dashboard':
                    renderDashboardPage();
                    break;
                case 'assessment':
                    if (domainId) {
                        renderAssessmentPage(domainId);
                    }
                    break;
                case 'priorities':
                    renderPrioritiesPage();
                    break;
            }
        }

        function renderHomePage() {
            // Content is static HTML, nothing to render
        }

        function renderDashboardPage() {
            const { 
                domainScores, 
                grandTotalScore, 
                grandTotalMax, 
                grandTotalTargetScore, 
                overallPercent, 
                overallTargetPercent,
                overallAssessmentCompletion,
                grandTotalAssessed,
                grandTotalPractices
            } = calculateAllScores();
            
            // 1. Populate Table
            const tableBody = document.getElementById('dashboard-table-body');
            tableBody.innerHTML = ''; // Clear old data
            
            domainScores.forEach(domain => {
                // Use map for domain name (fixes "nan" bug)
                const domainName = DOMAIN_NAME_MAP[domain.id] || domain.nickname;
                const row = `
                    <tr class="hover:bg-slate-50">
                        <td class="py-4 px-6 text-sm font-medium text-slate-900">${domainName}</td>
                        <td class="py-4 px-6 text-sm text-slate-500">${domain.totalScore}</td>
                        <td class="py-4 px-6 text-sm text-slate-500">${domain.totalMax}</td>
                        <td class="py-4 px-6 text-sm text-slate-500">
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${domain.percent.toFixed(0)}%"></div>
                            </div>
                            <span class="text-xs">${domain.percent.toFixed(1)}%</span>
                        </td>
                        <td class="py-4 px-6 text-sm text-slate-500">
                             <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${domain.targetPercent.toFixed(0)}%"></div>
                            </div>
                            <span class="text-xs">${domain.targetPercent.toFixed(1)}%</span>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // 2. Populate Table Footer
            const tableFooter = document.getElementById('dashboard-table-footer');
            tableFooter.innerHTML = `
                <td class="py-4 px-6 text-sm">Total</td>
                <td class="py-4 px-6 text-sm">${grandTotalScore}</td>
                <td class="py-4 px-6 text-sm">${grandTotalMax}</td>
                <td class="py-4 px-6 text-sm">${overallPercent.toFixed(1)}%</td>
                <td class="py-4 px-6 text-sm">${overallTargetPercent.toFixed(1)}%</td>
            `;

            // 3. Render Radar Chart
            const radarCtx = document.getElementById('maturityRadarChart').getContext('2d');
            if (chartInstances.radar) {
                chartInstances.radar.destroy();
            }
            chartInstances.radar = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: domainScores.map(d => d.nickname),
                    datasets: [
                        {
                            label: 'Current Maturity %',
                            data: domainScores.map(d => d.percent),
                            backgroundColor: 'rgba(59, 130, 246, 0.2)', // blue
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        },
                        {
                            label: 'Target Maturity %',
                            data: domainScores.map(d => d.targetPercent),
                            backgroundColor: 'rgba(22, 163, 74, 0.2)', // green
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(22, 163, 74, 1)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });

            // 4. Render Doughnut Chart
            const doughnutCtx = document.getElementById('overallProgressDoughnut').getContext('2d');
            if (chartInstances.doughnut) {
                chartInstances.doughnut.destroy();
            }
            chartInstances.doughnut = new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    // ==================================
                    // === START MODIFICATION: Update doughnut chart ===
                    // ==================================
                    labels: ['Assessed', 'Not Assessed'],
                    datasets: [{
                        data: [grandTotalAssessed, grandTotalPractices - grandTotalAssessed],
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                        backgroundColor: ['rgba(59, 130, 246, 1)', 'rgba(229, 231, 235, 1)'],
                        borderColor: ['rgba(59, 130, 246, 1)', 'rgba(229, 231, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        title: {
                            // ==================================
                            // === START MODIFICATION: Update doughnut title ===
                            // ==================================
                            display: true,
                            text: `${overallAssessmentCompletion.toFixed(1)}%`,
                            // ==================================
                            // === END MODIFICATION ===
                            // ==================================
                            position: 'top', // 'bottom' to put it in center
                            font: { size: 40, weight: 'bold' },
                            color: '#1e293b',
                            padding: 0
                        },
                        subtitle: {
                            display: true,
                            // ==================================
                            // === START MODIFICATION: Update doughnut subtitle ===
                            // ==================================
                            text: 'Overall Assessment',
                            // ==================================
                            // === END MODIFICATION ===
                            // ==================================
                            font: { size: 16 },
                            color: '#64748b',
                            padding: { bottom: 30 }
                        }
                    }
                }
            });
        }

        // Helper: Create form elements dynamically
        function createSelect(options, selectedValue, practiceId, field) {
            const select = document.createElement('select');
            select.className = "p-1 border rounded-md bg-white w-full"; // Changed to w-full
            select.dataset.id = practiceId;
            select.dataset.field = field;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.text;
                if (opt.value == selectedValue) { // Use == for loose comparison
                    option.selected = true;
                }
                select.appendChild(option);
            });
            return select;
        }
        
        function createInput(type, value, practiceId, field, placeholder = '') {
            const input = document.createElement('input');
            input.type = type;
            input.className = "p-1 border rounded-md w-full";
            input.value = value;
            input.dataset.id = practiceId;
            input.dataset.field = field;
            input.placeholder = placeholder;
            return input;
        }
        
        function createTextarea(value, practiceId, field, placeholder = '') {
            const textarea = document.createElement('textarea');
            textarea.value = value;
            textarea.dataset.id = practiceId;
            textarea.dataset.field = field;
            textarea.placeholder = placeholder;
            // Class and rows set in renderAssessmentPage
            return textarea;
        }

        // --- START NEW/MODIFIED FUNCTIONS ---

        const scoreLevels = [
            { value: 0, title: "Not Implemented" },
            { value: 1, title: "Partially Implemented" },
            { value: 2, title: "Largely Implemented" },
            { value: 3, title: "Fully Implemented" }
        ];

        function createCurrentMaturityWidget(practice) {
            // ==================================
            // === START MODIFICATION: Handle null score ===
            // ==================================
            const score = parseScore(practice.score);
            // ==================================
            // === END MODIFICATION ===
            // ==================================
            const widget = document.createElement('div');
            widget.className = "maturity-widget";
            widget.dataset.id = practice.id;

            scoreLevels.forEach((s, index) => {
                const dotWrapper = document.createElement('div');
                dotWrapper.className = "flex flex-col items-center";
                
                const dot = document.createElement('div');
                dot.className = "maturity-dot";
                dot.dataset.score = s.value;
                dot.dataset.field = "score"; // Set field
                dot.title = s.title;

                // ==================================
                // === START MODIFICATION: Handle null score ===
                // ==================================
                if (score !== null) {
                    if (s.value === score) {
                        dot.classList.add('active', 'selected');
                    } else if (s.value < score) {
                        dot.classList.add('active');
                    }
                }
                // ==================================
                // === END MODIFICATION ===
                // ==================================
                
                const label = document.createElement('div');
                label.className = "maturity-label";
                label.textContent = s.value;
                
                dotWrapper.appendChild(dot);
                dotWrapper.appendChild(label);
                widget.appendChild(dotWrapper);

                if (index < scoreLevels.length - 1) {
                    const line = document.createElement('div');
                    line.className = "maturity-line";
                    // ==================================
                    // === START MODIFICATION: Handle null score ===
                    // ==================================
                    if (score !== null && s.value < score) {
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                        line.classList.add('active');
                    }
                    widget.appendChild(line);
                }
            });
            return widget;
        }

        function createTargetMaturityWidget(practice) {
            // ==================================
            // === START MODIFICATION: Handle null score ===
            // ==================================
            const score = parseScore(practice.targetScore);
            // ==================================
            // === END MODIFICATION ===
            // ==================================
            const widget = document.createElement('div');
            widget.className = "target-widget"; // Use target class
            widget.dataset.id = practice.id;

            scoreLevels.forEach((s, index) => {
                const dotWrapper = document.createElement('div');
                dotWrapper.className = "flex flex-col items-center";
                
                const dot = document.createElement('div');
                dot.className = "target-dot"; // Use target class
                dot.dataset.score = s.value;
                dot.dataset.field = "targetScore"; // Set field
                dot.title = `Target: ${s.title}`;

                // ==================================
                // === START MODIFICATION: Handle null score ===
                // ==================================
                if (score !== null) {
                    if (s.value === score) {
                        dot.classList.add('active', 'selected');
                    } else if (s.value < score) {
                        dot.classList.add('active');
                    }
                }
                // ==================================
                // === END MODIFICATION ===
                // ==================================
                
                const label = document.createElement('div');
                label.className = "maturity-label";
                label.textContent = s.value;
                
                dotWrapper.appendChild(dot);
                dotWrapper.appendChild(label);
                widget.appendChild(dotWrapper);

                if (index < scoreLevels.length - 1) {
                    const line = document.createElement('div');
                    line.className = "target-line"; // Use target class
                    // ==================================
                    // === START MODIFICATION: Handle null score ===
                    // ==================================
                    if (score !== null && s.value < score) {
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                        line.classList.add('active');
                    }
                    widget.appendChild(line);
                }
            });
            return widget;
        }

        // ==================================
        // === START MODIFICATION: NEW HELPER FOR PRIORITIES PAGE ===
        // ==================================
        /**
         * Creates a non-interactive HTML string for a display widget.
         * Used on the Priorities page.
         */
        function createDisplayMaturityWidget(score, type = 'current') {
            // ==================================
            // === START MODIFICATION: Handle null score ===
            // ==================================
            const intScore = parseScore(score);
            // ==================================
            // === END MODIFICATION ===
            // ==================================
            const baseClass = type === 'current' ? 'maturity' : 'target';
            const widgetClass = type === 'current' ? 'maturity-widget' : 'target-widget';

            // Override padding for tight table cell
            let html = `<div class="${widgetClass}" style="padding-top: 0; padding-left: 8px;">`; 
            
            scoreLevels.forEach((s, index) => {
                const dotClasses = [`${baseClass}-dot`];
                // ==================================
                // === START MODIFICATION: Handle null score ===
                // ==================================
                if (intScore !== null) {
                    if (s.value === intScore) {
                        dotClasses.push('active', 'selected');
                    } else if (s.value < intScore) {
                        dotClasses.push('active');
                    }
                }
                // ==================================
                // === END MODIFICATION ===
                // ==================================
                
                // Dot wrapper
                html += `<div class="flex flex-col items-center">`;
                // Dot
                html += `<div class="${dotClasses.join(' ')}" title="${intScore === null ? 'Not Assessed' : s.title}"></div>`; 
                // Label
                html += `<div class="maturity-label">${s.value}</div>`;
                html += `</div>`; // End dot wrapper

                if (index < scoreLevels.length - 1) {
                    const lineClasses = [`${baseClass}-line`];
                    // ==================================
                    // === START MODIFICATION: Handle null score ===
                    // ==================================
                    if (intScore !== null && s.value < intScore) {
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                        lineClasses.push('active');
                    }
                    html += `<div class="${lineClasses.join(' ')}"></div>`;
                }
            });
            
            html += `</div>`;
            return html;
        }
        // ==================================
        // === END MODIFICATION ===
        // ==================================

        function updateDotWidget(widgetElement, newScore) {
            const score = parseInt(newScore, 10);
            const dots = widgetElement.querySelectorAll('.maturity-dot, .target-dot');
            const lines = widgetElement.querySelectorAll('.maturity-line, .target-line');

            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'selected');
                const dotScore = parseInt(dot.dataset.score, 10);

                if (dotScore === score) {
                    dot.classList.add('active', 'selected');
                } else if (dotScore < score) {
                    dot.classList.add('active');
                }

                if (index < lines.length) {
                    const line = lines[index];
                    line.classList.remove('active');
                    if (dotScore < score) {
                        line.classList.add('active');
                    }
                }
            });
        }
        
        function updateNavVisibility() {
            // Select the <a> tag first
            const planningNavLinks = document.querySelectorAll('a[data-page="priorities"]');
            
            // Loop over the <a> tags and hide/show their parent <LI> element
            planningNavLinks.forEach(link => {
                if (link.parentElement) { // Safety check
                    link.parentElement.style.display = (appMode === 'planning') ? 'block' : 'none';
                }
            });

            // If we're hiding the priorities page and we are *on* it, go home.
            if (appMode === 'benchmark' && activePage === 'priorities') {
                showPage('home');
            }
        }
        
        // ==================================
        // === START MODIFICATION: New sidebar progress updater ===
        // ==================================
        function updateSidebarProgress() {
            CMM_DATA.domains.forEach(domain => {
                const { assessmentCompletion } = calculateDomainScores(domain.id);
                const percent = assessmentCompletion.toFixed(0);
                
                const label = document.querySelector(`[data-progress-label-domain="${domain.id}"]`);
                const bar = document.querySelector(`[data-progress-bar-domain="${domain.id}"]`);
                
                if (label) {
                    label.textContent = `${percent}%`;
                }
                if (bar) {
                    bar.style.width = `${percent}%`;
                }
            });
        }
        // ==================================
        // === END MODIFICATION ===
        // ==================================
        // --- END NEW/MODIFIED FUNCTIONS ---

function renderAssessmentPage(domainId) {
            const domain = CMM_DATA.domains.find(d => d.id === domainId);
            // This is the data built by the *fixed* getDefaultAssessmentData
            const domainData = assessmentData[domainId];
            if (!domain || !domainData) {
                console.error('Domain not found:', domainId);
                return;
            }

            // Set title (using the "nan" bug patch)
            const domainName = DOMAIN_NAME_MAP[domain.id] || domain.nickname;
            document.getElementById('assessment-title').textContent = domainName;

            // Set header fields
            document.getElementById('assessment-date').value = domainData.date;
            document.getElementById('assessment-relevant').checked = domainData.relevant;

            // Render summary
            updateAssessmentSummary(domainId);

            // Render objectives
            const container = document.getElementById('assessment-objectives-container');
            container.innerHTML = ''; // Clear old data

            const impactOptions = [
                { value: 1, text: "1-Low" }, { value: 2, text: "2-Med" }, { value: 3, text: "3-High" }
            ];
            
            // This loop will now correctly iterate over all objectives (1, 2, and 3)
            // because `domainData.objectives` is now a correct array
            domainData.objectives.forEach((objective, objIndex) => {
                // Create objective container (using details/summary for collapse)
                const details = document.createElement('details');
                details.className = "bg-white rounded-lg shadow-md overflow-hidden";
                details.open = true; // Open by default
                
                const summary = document.createElement('summary');
                summary.className = "cursor-pointer bg-slate-100 p-4 font-semibold text-lg hover:bg-slate-200 flex justify-between";
                // objective.name is now the clean name, e.g., "IMPROVE ASSET VISIBILITY"
                summary.textContent = objective.name; 
                details.appendChild(summary);

                // Calculate subtotals for objective
                // ==================================
                // === START MODIFICATION: Update subtotal logic ===
                // ==================================
                let objTotalScore = 0;
                let objTotalMax = 0;
                let objTotalAssessed = 0;
                let objTotalPractices = 0;
                // ==================================
                // === END MODIFICATION ===
                // ==================================

                // Group practices by maturity
                const practicesByMaturity = {
                    'CTI 1': [],
                    'CTI 2': [],
                    'CTI 3': []
                };
                
                // This loop will work now because objective.practices is a valid array
                objective.practices.forEach(practice => {
                    // ==================================
                    // === START MODIFICATION: Update subtotal logic ===
                    // ==================================
                    objTotalPractices++;
                    const currentScore = parseScore(practice.score);
                    if (currentScore !== null) {
                        objTotalAssessed++;
                        objTotalScore += currentScore;
                    }
                    objTotalMax += parseInt(practice.max, 10) || 0;
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                    
                    // Group for rendering
                    let maturityKey = practice.maturity.replace(/\s+/g, ' ').toUpperCase(); // Normalize key
                    if (maturityKey.startsWith('CTI1')) maturityKey = 'CTI 1';
                    if (maturityKey.startsWith('CTI2')) maturityKey = 'CTI 2';
                    if (maturityKey.startsWith('CTI3')) maturityKey = 'CTI 3';
                    
                    if (practicesByMaturity.hasOwnProperty(maturityKey)) {
                        practicesByMaturity[maturityKey].push(practice);
                    } else {
                        // Fallback for unexpected maturity values
                        if (!practicesByMaturity['Other']) practicesByMaturity['Other'] = [];
                        practicesByMaturity['Other'].push(practice);
                    }
                });

                // Create a container for the maturity groups
                const maturityGroupsContainer = document.createElement('div');
                maturityGroupsContainer.className = "p-4 space-y-4";

                // Loop over CTI 1, CTI 2, CTI 3 and render tables
                for (const maturityLevel of ['CTI 1', 'CTI 2', 'CTI 3', 'Other']) {
                    const practices = practicesByMaturity[maturityLevel];
                    if (!practices || practices.length === 0) continue; // Don't render if no practices
                    
                    // Create group header (e.g., "CTI 1 - Foundational")
                    const groupHeader = document.createElement('h4');
                    groupHeader.className = "text-md font-semibold text-slate-700 pt-2";
                    let maturityName = "Foundational";
                    if (maturityLevel === 'CTI 2') maturityName = "Intermediate";
                    if (maturityLevel === 'CTI 3') maturityName = "Advanced";
                    if (maturityLevel === 'Other') maturityName = "Uncategorized";
                    groupHeader.textContent = `${maturityLevel} - ${maturityName}`;
                    maturityGroupsContainer.appendChild(groupHeader);
                    
                    // Create table for this group
                    const tableContainer = document.createElement('div');
                    tableContainer.className = "overflow-x-auto border rounded-md";
                    
                    const table = document.createElement('table');
                    table.className = "min-w-full assessment-table";
                    
                    // Removed the <thead> entirely
                    
                    const tbody = document.createElement('tbody');
                    tbody.className = "bg-white"; // Removed divide-y

                    practices.forEach(practice => {
                        // --- START MODIFICATION: Two-mode, two-row widget layout ---
                        
                        // Row 1: Practice Info (Slug + Text)
                        const rowInfo = document.createElement('tr');
                        rowInfo.className = "bg-slate-50"; // Add light background
                        
                        const cellInfo = document.createElement('td');
                        cellInfo.colSpan = 5; // 5 columns
                        // Add padding, remove bottom border
                        cellInfo.className = "pt-4 pb-2 px-4 border-b-0"; 
                        cellInfo.innerHTML = `
                            <div class="font-semibold text-slate-800">${practice.slug}</div>
                            <div class="text-slate-600 mt-1">${practice.text}</div>
                        `;
                        rowInfo.appendChild(cellInfo);
                        tbody.appendChild(rowInfo);

                        // Row 2: Top Widgets (Benchmark + Planning)
                        const rowWidgets1 = document.createElement('tr');
                        
                        // Col 1: Current Maturity
                        const cellCurrent = document.createElement('td');
                        cellCurrent.className = "pb-2 pl-4 w-[180px]";
                        cellCurrent.innerHTML = `<div class="widget-label" title="Your current score">Current level</div>`;
                        cellCurrent.appendChild(createCurrentMaturityWidget(practice));
                        rowWidgets1.appendChild(cellCurrent);

                        // Col 2: Evidence
                        const cellEvidence = document.createElement('td');
                        cellEvidence.className = "pb-2 w-[20%]";
                        cellEvidence.innerHTML = `<div class="widget-label">Evidence</div>`;
                        cellEvidence.appendChild(createInput('text', practice.evidence, practice.id, 'evidence', 'Link/doc...'));
                        rowWidgets1.appendChild(cellEvidence);
                        
                        if (appMode === 'planning') {
                            // --- PLANNING MODE (Row 1) ---
                            
                            // Col 3: Point of Contact (Moved from Row 2)
                            const cellPoc = document.createElement('td');
                            cellPoc.className = "pb-2 w-[20%]"; // Use pb-2 for top row
                            cellPoc.innerHTML = `<div class="widget-label" title="Point of Contact...">Point of Contact</div>`;
                            cellPoc.appendChild(createInput('text', practice.poc, practice.id, 'poc', 'Name/team...'));
                            rowWidgets1.appendChild(cellPoc);
                            
                            // Col 4: Blank Cell (above Effort)
                            const cellBlank = document.createElement('td');
                            cellBlank.className = "pb-2 w-[120px]";
                            cellBlank.innerHTML = `<div class="widget-label">&nbsp;</div>`; // Empty label
                            rowWidgets1.appendChild(cellBlank);

                        } else {
                            // --- BENCHMARK MODE ---
                            // Col 3: Point of Contact (Benchmark Mode)
                            const cellPoc = document.createElement('td');
                            cellPoc.className = "pb-2 w-[20%]";
                            cellPoc.colSpan = 2; // Span over Impact/Priority columns
                            cellPoc.innerHTML = `<div class="widget-label" title="Point of Contact...">Point of Contact</div>`;
                            cellPoc.appendChild(createInput('text', practice.poc, practice.id, 'poc', 'Name/team...'));
                            rowWidgets1.appendChild(cellPoc);
                        }

                        // Col 5: Notes
                        const cellNotes = document.createElement('td');
                        cellNotes.className = "pb-2 pr-4 w-auto h-full"; 
                        cellNotes.rowSpan = 1; // ALWAYS span 1 row
                        cellNotes.innerHTML = `<div class="widget-label">Notes</div>`;
                        const notesTextarea = createTextarea(practice.notes, practice.id, 'notes', 'Reasoning...');
                        notesTextarea.rows = 2; // ALWAYS 2 rows
                        notesTextarea.className = "p-1 border rounded-md w-full h-full min-h-[4rem]";
                        cellNotes.appendChild(notesTextarea);
                        rowWidgets1.appendChild(cellNotes);

                        tbody.appendChild(rowWidgets1);

                        // Row 3: Bottom Widgets (Planning ONLY)
                        if (appMode === 'planning') {
                            const rowWidgets2 = document.createElement('tr');

                            // Col 1: Target Maturity
                            const cellTarget = document.createElement('td');
                            cellTarget.className = "pb-4 pl-4 w-[180px]";
                            cellTarget.innerHTML = `<div class="widget-label" title="Your target score">Target level</div>`;
                            cellTarget.appendChild(createTargetMaturityWidget(practice));
                            rowWidgets2.appendChild(cellTarget);

                            // Col 2: Target Date
                            const cellTargetDate = document.createElement('td');
                            cellTargetDate.className = "pb-4 w-[20%]";
                            cellTargetDate.innerHTML = `<div class="widget-label">Target Date</div>`;
                            cellTargetDate.appendChild(createInput('date', practice.targetDate, practice.id, 'targetDate'));
                            rowWidgets2.appendChild(cellTargetDate);

                            // Col 3: Impact (Moved from Row 1)
                            const cellImpact = document.createElement('td');
                            cellImpact.className = "pb-4 w-[20%]"; // Use pb-4 for bottom row
                            cellImpact.innerHTML = `<div class="widget-label" title="What will this measure mean for business gains..._">Impact</div>`;
                            cellImpact.appendChild(createSelect(impactOptions, practice.impact, practice.id, 'impact'));
                            rowWidgets2.appendChild(cellImpact);
                            
                            // Col 4: Effort
                            const cellLoe = document.createElement('td');
                            cellLoe.className = "pb-4 w-[120px]";
                            cellLoe.innerHTML = `<div class="widget-label" title="Represents level of effort required...">Effort</div>`;
                            cellLoe.appendChild(createSelect(impactOptions, practice.loe, practice.id, 'loe'));
                            rowWidgets2.appendChild(cellLoe);

                            // Col 5: Priority (Moved from Row 1)
                            const cellPriority = document.createElement('td');
                            cellPriority.className = "pb-4 pr-4 w-auto"; // Match notes column padding
                            cellPriority.innerHTML = `<div class="widget-label">Priority</div>`;
                            const priorityDisplay = document.createElement('div');
                            priorityDisplay.className = "p-1 font-bold text-slate-700 text-lg text-left";
                            priorityDisplay.dataset.priorityId = practice.id;
                            priorityDisplay.textContent = calculatePriority(practice.impact, practice.loe);
                            cellPriority.appendChild(priorityDisplay);
                            rowWidgets2.appendChild(cellPriority);
                            
                            tbody.appendChild(rowWidgets2);
                        }
                        
                        // --- END MODIFICATION ---
                     });
                    
                    table.appendChild(tbody);
                    tableContainer.appendChild(table);
                    maturityGroupsContainer.appendChild(tableContainer);
                }

                details.appendChild(maturityGroupsContainer);

                // Add the subtotal element
                // ==================================
                // === START MODIFICATION: Update subtotal logic ===
                // ==================================
                const objPercent = objTotalMax > 0 ? (objTotalScore / objTotalMax) * 100 : 0;
                const objCompletion = objTotalPractices > 0 ? (objTotalAssessed / objTotalPractices) * 100 : 0;
                const subtotalEl = document.createElement('div');
                subtotalEl.className = "bg-slate-50 p-4 font-bold text-sm flex justify-end space-x-6 border-t border-slate-200";
                // Add data-attribute to find this element later
                subtotalEl.dataset.objectiveId = objective.name;
                subtotalEl.innerHTML = `
                    <span class="font-semibold">Section Subtotal:</span>
                    <span class="text-right">Completed: ${objTotalAssessed} / ${objTotalPractices} (${objCompletion.toFixed(1)}%)</span>
                    <span class="text-right">Score: ${objTotalScore} / ${objTotalMax} (${objPercent.toFixed(1)}%)</span>
                `;
                // ==================================
                // === END MODIFICATION ===
                // ==================================
                details.appendChild(subtotalEl); // Add it to the <details> block
                
                container.appendChild(details);
            });
        }
        
        function updateAssessmentSummary(domainId) {
            // ==================================
            // === START MODIFICATION: Add progress bar to assessment page ===
            // ==================================
            const { totalScore, totalMax, percent, assessmentCompletion } = calculateDomainScores(domainId);
            
            // 1. Update Score Summary
            const summaryEl = document.getElementById('assessment-summary');
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <span class="font-bold">Domain Score:</span> ${totalScore} / ${totalMax}
                    <span class="font-bold ml-4">Completion:</span> ${percent.toFixed(1)}%
                `;
            }

            // 2. Create/Update Progress Bar
            let progressEl = document.getElementById('assessment-page-progress');
            const summaryParent = document.getElementById('assessment-summary').parentElement;
            
            // Create the progress element if it doesn't exist
            if (!progressEl && summaryParent) {
                progressEl = document.createElement('div');
                progressEl.id = 'assessment-page-progress';
                progressEl.className = 'w-1/4'; // Give it some width
                // Insert it before the summary element
                summaryParent.insertBefore(progressEl, summaryEl);
            }
            
            // Populate the progress bar
            if (progressEl) {
                const percent = assessmentCompletion.toFixed(0);
                progressEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-slate-700">Assessment Progress</span>
                        <span class="text-sm font-medium text-slate-500">${percent}%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percent}%"></div>
                    </div>
                `;
            }
            // ==================================
            // === END MODIFICATION ===
            // ==================================
        }

        // ==================================
        // === START MODIFICATION: RE-WRITE renderPrioritiesPage ===
        // ==================================
        function renderPrioritiesPage() {
            const tableBody = document.getElementById('priorities-table-body');
            tableBody.innerHTML = ''; // Clear old data

            let priorityItems = [];
            // This loop now works correctly
            for (const domainId in assessmentData) {
                const domain = assessmentData[domainId];
                const domainMeta = CMM_DATA.domains.find(d => d.id === domainId);
                
                domain.objectives.forEach(objective => {
                    objective.practices.forEach(practice => {
                        // ==================================
                        // === START MODIFICATION: Update priority logic ===
                        // ==================================
                        const currentScore = parseScore(practice.score);
                        const targetScore = parseScore(practice.targetScore);
                        
                        // Only include items where target is set and (current is null or target > current)
                        if (targetScore !== null && (currentScore === null || targetScore > currentScore)) {
                        // ==================================
                        // === END MODIFICATION ===
                        // ==================================
                            priorityItems.push({
                                domain: domainMeta ? domainMeta.nickname : domainId,
                                objective: objective.name, // Use the clean name
                                practice: practice.slug, // Use slug for practice
                                date: practice.targetDate, // Use 'date' for sorting
                                ...practice
                            });
                        }
                    });
                });
            }

            // Sort items based on the global prioritySort state
            priorityItems.sort((a, b) => {
                const col = prioritySort.column;
                let valA, valB;

                // Get values based on column
                switch (col) {
                    case 'priority':
                        valA = calculatePriority(a.impact, a.loe);
                        valB = calculatePriority(b.impact, b.loe);
                        // Handle '-' for non-numeric (sorts to bottom)
                        if (valA === '-') valA = -Infinity;
                        if (valB === '-') valB = -Infinity;
                        break;
                    // ==================================
                    // === START MODIFICATION: Update sort logic for null ===
                    // ==================================
                    case 'impact':
                    case 'loe':
                        valA = parseInt(a[col], 10) || 0;
                        valB = parseInt(b[col], 10) || 0;
                        break;
                    case 'score':
                    case 'target':
                        // Use targetScore for 'target' column
                        const key = col === 'target' ? 'targetScore' : col;
                        valA = parseScore(a[key]);
                        valB = parseScore(b[key]);
                        // Sort nulls (Not Assessed) before 0
                        if (valA === null) valA = -1;
                        if (valB === null) valB = -1;
                        break;
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                    case 'date': // Target Date
                        valA = a.targetDate || '';
                        valB = b.targetDate || '';
                        // Handle empty dates (sort them to the end)
                        if (valA === '' && valB !== '') return 1;
                        if (valA !== '' && valB === '') return -1;
                        if (valA === '' && valB === '') return 0;
                        break;
                    case 'domain':
                    // case 'objective': // Removed
                    case 'practice': 
                    case 'notes':
                    default:
                        valA = (a[col] || '').toLowerCase();
                        valB = (b[col] || '').toLowerCase();
                        break;
                }

                let result = 0;
                if (typeof valA === 'number' && typeof valB === 'number') {
                    result = valA - valB;
                } else if (typeof valA === 'string' && typeof valB === 'string') {
                    result = valA.localeCompare(valB);
                }
                
                return prioritySort.direction === 'desc' ? result * -1 : result;
            });
            
            // Update header sort indicators
            const headers = document.querySelectorAll('#page-priorities .sortable-header');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === prioritySort.column) {
                    header.classList.add(prioritySort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            if (priorityItems.length === 0) {
                // Update colspan to 9
                tableBody.innerHTML = `<tr><td colspan="9" class="p-6 text-center text-slate-500">No priority items found. (Ensure 'Target' score is higher than 'Current' score for items in Planning Mode).</td></tr>`;
                return;
            }

            // Render rows
            priorityItems.forEach(item => {
                const priority = calculatePriority(item.impact, item.loe); // Calculate priority
                const row = `
                    <tr class="hover:bg-slate-50">
                        <td class="py-4 px-4 text-sm font-medium text-slate-900">${item.domain}</td>
                        <td class="py-4 px-4 text-sm text-slate-700">${item.practice}</td>
                        <td class="py-2 px-4 text-sm text-slate-500">${createDisplayMaturityWidget(item.score, 'current')}</td>
                        <td class="py-2 px-4 text-sm text-slate-500">${createDisplayMaturityWidget(item.targetScore, 'target')}</td>
                        <td class="py-4 px-4 text-sm text-slate-500">${item.impact || '-'}</td>
                        <td class="py-4 px-4 text-sm text-slate-500">${item.loe || '-'}</td>
                        <td class="py-4 px-4 text-sm text-slate-500 font-bold text-center">${priority}</td>
                        <td class="py-4 px-4 text-sm text-slate-500">${item.targetDate}</td>
                        <td class="py-4 px-4 text-sm text-slate-500">${item.notes.substring(0, 50)}...</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        // ==================================
        // === END MODIFICATION ===
        // ==================================


        // ==================================
        // === START MODIFICATION: CSV EXPORT FUNCTIONS ===
        // ==================================
        function escapeCSV(str) {
            if (str === null || str === undefined) {
                return '""';
            }
            let result = String(str);
            // Check if it needs quoting
            if (result.includes('"') || result.includes(',') || result.includes('\n')) {
                // Escape quotes by doubling them
                result = result.replace(/"/g, '""');
                // Wrap in quotes
                result = `"${result}"`;
            }
            return result;
        }

        function exportPrioritiesToCSV() {
            console.log('Exporting priorities to CSV...');
            
            // 1. Get Data (same logic as renderPrioritiesPage)
            let priorityItems = [];
            for (const domainId in assessmentData) {
                const domain = assessmentData[domainId];
                const domainMeta = CMM_DATA.domains.find(d => d.id === domainId);
                
                domain.objectives.forEach(objective => {
                    objective.practices.forEach(practice => {
                        // ==================================
                        // === START MODIFICATION: Update priority logic ===
                        // ==================================
                        const currentScore = parseScore(practice.score);
                        const targetScore = parseScore(practice.targetScore);
                        
                        // Only include items where target is set and (current is null or target > current)
                        if (targetScore !== null && (currentScore === null || targetScore > currentScore)) {
                        // ==================================
                        // === END MODIFICATION ===
                        // ==================================
                            priorityItems.push({
                                domain: domainMeta ? domainMeta.nickname : domainId,
                                objective: objective.name,
                                practice: practice.slug,
                                date: practice.targetDate,
                                ...practice
                            });
                        }
                    });
                });
            }

            // 2. Sort Data (same logic as renderPrioritiesPage)
            priorityItems.sort((a, b) => {
                const col = prioritySort.column;
                let valA, valB;
                
                switch (col) {
                    case 'priority':
                        valA = calculatePriority(a.impact, a.loe);
                        valB = calculatePriority(b.impact, b.loe);
                        if (valA === '-') valA = -Infinity;
                        if (valB === '-') valB = -Infinity;
                        break;
                    // ==================================
                    // === START MODIFICATION: Update sort logic for null ===
                    // ==================================
                    case 'impact':
                    case 'loe':
                        valA = parseInt(a[col], 10) || 0;
                        valB = parseInt(b[col], 10) || 0;
                        break;
                    case 'score':
                    case 'target':
                        const key = col === 'target' ? 'targetScore' : col;
                        valA = parseScore(a[key]);
                        valB = parseScore(b[key]);
                        // Sort nulls (Not Assessed) before 0
                        if (valA === null) valA = -1;
                        if (valB === null) valB = -1;
                        break;
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                    case 'date':
                        valA = a.targetDate || '';
                        valB = b.targetDate || '';
                        if (valA === '' && valB !== '') return 1;
                        if (valA !== '' && valB === '') return -1;
                        if (valA === '' && valB === '') return 0;
                        break;
                    case 'domain':
                    // case 'objective': // Removed
                    case 'practice': 
                    case 'notes':
                    default:
                        valA = (a[col] || '').toLowerCase();
                        valB = (b[col] || '').toLowerCase();
                        break;
                }
                let result = 0;
                if (typeof valA === 'number' && typeof valB === 'number') {
                    result = valA - valB;
                } else if (typeof valA === 'string' && typeof valB === 'string') {
                    result = valA.localeCompare(valB);
                }
                return prioritySort.direction === 'desc' ? result * -1 : result;
            });

            // 3. Build CSV String
            const headers = [
                'Domain', 'Practice', 'Score', 'Target', 'Impact', 'Effort', 'Priority', 'Target Date', 'Notes'
            ];
            let csvContent = headers.join(',') + '\n';

            priorityItems.forEach(item => {
                const priority = calculatePriority(item.impact, item.loe);
                const row = [
                    item.domain,
                    item.practice,
                    // ==================================
                    // === START MODIFICATION: Handle null in CSV ===
                    // ==================================
                    // Use parseScore to handle null, but output empty string if null
                    parseScore(item.score) === null ? '' : item.score,
                    parseScore(item.targetScore) === null ? '' : item.targetScore,
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                    item.impact || '',
                    item.loe || '',
                    priority,
                    item.targetDate || '',
                    item.notes || ''
                ];
                csvContent += row.map(escapeCSV).join(',') + '\n';
            });

            // 4. Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Check for download attribute support
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'cti-cmm-priorities.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                alert('Your browser does not support automatic CSV downloads. Please try a different browser.');
            }
        }
        // ==================================
        // === END MODIFICATION ===
        // ==================================


        // --- EVENT HANDLERS ---
        function handleNavClick(e) {
            const target = e.target.closest('.nav-link');
            
            // Only prevent default IF we clicked a nav link
            if (target) {
                e.preventDefault(); 
                const pageId = target.dataset.page;
                const domainId = target.dataset.domain;
                showPage(pageId, domainId);
            }
            // If the target isn't a .nav-link (like our checkbox),
            // this function will do nothing and allow the default
            // click behavior to proceed.
        }
        
        function handleAssessmentChange(e) {
            const target = e.target;
            const practiceId = target.dataset.id;
            const field = target.dataset.field;
            
            if (!practiceId || !field) {
                // Not a dynamic field
                // Check for domain-level fields
                if (target.id === 'assessment-date') {
                    if(assessmentData[activeDomain]) assessmentData[activeDomain].date = target.value;
                }
                if (target.id === 'assessment-relevant') {
                    if(assessmentData[activeDomain]) assessmentData[activeDomain].relevant = target.checked;
                }
                saveState();
                return;
            }
            
            const { practice, domainId, objective } = getPracticeById(practiceId);
            if (practice) {
                let value = target.type === 'checkbox' ? target.checked : target.value;
                
                // Convert numbers
                if (field === 'score' || field === 'targetScore' || field === 'impact' || field === 'loe' || field === 'max') {
                    // ==================================
                    // === START MODIFICATION: Allow nulls, parse ints ===
                    // ==================================
                    // Don't parse 'score' or 'targetScore' here, widget click handles it.
                    // This is for dropdowns/text inputs
                    if (field === 'impact' || field === 'loe' || field === 'max') {
                         value = parseInt(value, 10);
                    }
                    // ==================================
                    // === END MODIFICATION ===
                    // ==================================
                }
                
                practice[field] = value;

                // Recalculate priority if impact or loe changed
                if (field === 'impact' || field === 'loe') {
                    const priorityDisplay = document.querySelector(`[data-priority-id="${practice.id}"]`);
                    if (priorityDisplay) {
                        priorityDisplay.textContent = calculatePriority(practice.impact, practice.loe);
                    }
                }
                
                // Save state and update summary
                saveState();
                updateAssessmentSummary(activeDomain);
                
                // Update objective subtotal
                if (objective) {
                    updateObjectiveSubtotal(objective);
                }
            }
        }
        
        function handleWidgetClick(e) {
            const target = e.target.closest('.maturity-dot, .target-dot');
            if (!target) return; // Didn't click a dot

            const widget = target.closest('.maturity-widget, .target-widget');
            if (!widget) return;

            const practiceId = widget.dataset.id;
            const newScore = parseInt(target.dataset.score, 10);
            const field = target.dataset.field; // 'score' or 'targetScore'

            if (!field) return; // Should have a field

            const { practice, domainId, objective } = getPracticeById(practiceId);
            if (practice) {
                // ==================================
                // === START MODIFICATION: Toggle null/value ===
                // ==================================
                // If clicking the *currently selected* dot, set to null (unset)
                if (parseScore(practice[field]) === newScore) {
                    practice[field] = null;
                    updateDotWidget(widget, null); // Update UI to show "unset"
                } else {
                // Otherwise, set the new score
                    practice[field] = newScore;
                    updateDotWidget(widget, newScore); // Update UI
                }
                // ==================================
                // === END MODIFICATION ===
                // ==================================
                
                // Save state
                saveState();
                
                // Update UI
                updateAssessmentSummary(activeDomain);
                if (objective) {
                    updateObjectiveSubtotal(objective);
                }
                
                // ==================================
                // === START MODIFICATION: Update sidebar progress ===
                // ==================================
                // If the current score was changed, update progress
                if (field === 'score') {
                    updateSidebarProgress();
                }
                // ==================================
                // === END MODIFICATION ===
                // ==================================
                
                // If the target was changed, refresh the dashboard and priorities pages
                if (field === 'targetScore') {
                    if (activePage === 'dashboard') renderDashboardPage();
                    if (activePage === 'priorities') renderPrioritiesPage();
                }
            }
        }
        
        function handleCollapseExpand(e) {
            const action = e.target.id;
            const detailsElements = document.querySelectorAll('#page-assessment details');
            detailsElements.forEach(details => {
                details.open = (action === 'expand-all');
            });
        }
        
        function handleModeToggle(e) {
            appMode = e.target.checked ? 'planning' : 'benchmark';
            saveMode();
            updateNavVisibility();

            showPage(activePage, activeDomain);
        }

        function handlePrioritySortClick(e) {
            const target = e.target.closest('.sortable-header');
            if (!target) return;

            const newColumn = target.dataset.sort;
            if (!newColumn) return;

            if (prioritySort.column === newColumn) {
                // Flip direction
                prioritySort.direction = (prioritySort.direction === 'asc') ? 'desc' : 'asc';
            } else {
                // New column
                prioritySort.column = newColumn;
                // Default sort directions (descending for numbers, ascending for text)
                const descDefaults = ['priority', 'impact', 'score', 'target'];
                prioritySort.direction = descDefaults.includes(newColumn) ? 'desc' : 'asc';
            }
            
            // Re-render the page
            renderPrioritiesPage();
        }

        // --- INITIALIZATION ---
        function initializeApp() {
            console.log('CTI-CMM Tool Initializing...');
            loadState(); // This now loads mode and data

            // Populate Domain Nav
            const domainNav = document.getElementById('domain-nav');
            // ==================================
            // === START MODIFICATION: Add progress bar to nav ===
            // ==================================
            CMM_DATA.domains.forEach(domain => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" class="nav-link block rounded-md py-2 px-3 hover:bg-slate-700 text-sm" data-page="assessment" data-domain="${domain.id}">
                    <div class="flex justify-between items-center">
                        <span>${domain.nickname}</span>
                        <span class="text-xs text-slate-400" data-progress-label-domain="${domain.id}">0%</span>
                    </div>
                    <div class="w-full bg-slate-600 rounded-full h-1 mt-1">
                        <div data-progress-bar-domain="${domain.id}" class="bg-blue-500 h-1 rounded-full" style="width: 0%"></div>
                    </div>
                </a>`;
                domainNav.appendChild(li);
            });
            // ==================================
            // === END MODIFICATION ===
            // ==================================

            // Attach Global Event Listeners
            document.getElementById('main-nav').addEventListener('click', handleNavClick);
            document.getElementById('reset-data').addEventListener('click', resetData);
            document.getElementById('mode-toggle').addEventListener('change', handleModeToggle); // Add listener for toggle
            
            // Assessment page listeners
            const assessmentPage = document.getElementById('page-assessment');
            assessmentPage.addEventListener('change', handleAssessmentChange);
            assessmentPage.addEventListener('click', handleWidgetClick); // Changed listener name
            document.getElementById('expand-all').addEventListener('click', handleCollapseExpand);
            document.getElementById('collapse-all').addEventListener('click', handleCollapseExpand);
            
            // ==================================
            // === START MODIFICATION: UPDATE LISTENERS ===
            // ==================================
            // Priorities page listener
            document.querySelector('#page-priorities thead').addEventListener('click', handlePrioritySortClick);
            document.getElementById('export-csv').addEventListener('click', exportPrioritiesToCSV);
            // ==================================
            // === END MODIFICATION ===
            // ==================================

            // Show initial page
            updateNavVisibility(); // Hide/show nav links based on mode
            
            // ==================================
            // === START MODIFICATION: Update sidebar on load ===
            // ==================================
            updateSidebarProgress();
            // ==================================
            // === END MODIFICATION ===
            // ==================================

            showPage('home');
            console.log('...Initialization Complete.');
        }

    </script>
</body>
</html>